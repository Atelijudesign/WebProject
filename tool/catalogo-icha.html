<!doctype html>
<html lang="es" class="scroll-smooth dark">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Herramientas BIM | Catálogo ICHA</title>
    <meta
      name="description"
      content="Catálogo de perfiles de acero ICHA con propiedades mecánicas. Selecciona perfiles, arma tu lista y exporta a Excel."
    />
    <link rel="icon" href="../assets/favicon.ico" sizes="any" />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap"
      rel="stylesheet"
    />
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx-js-style@1.2.0/dist/xlsx.bundle.js"></script>
    <script>
      tailwind.config = {
        darkMode: "class",
        theme: {
          extend: {
            colors: {
              "bim-blue": "#3b82f6",
              "bim-dark": "#0b1220",
              "bim-card": "#111827",
              "bim-border": "#1f2937",
            },
            fontFamily: { sans: ["Inter", "sans-serif"] },
          },
        },
      };
    </script>
    <style>
      .glass-card {
        background: rgba(17, 24, 39, 0.7);
        border: 1px solid rgba(55, 65, 81, 0.5);
        backdrop-filter: blur(12px);
      }
      .glass-nav {
        background: rgba(11, 18, 32, 0.85);
        backdrop-filter: blur(16px);
      }
      .profile-btn {
        transition: all 0.3s ease;
      }
      .profile-btn:hover,
      .profile-btn.active {
        border-color: #3b82f6;
        background: rgba(59, 130, 246, 0.1);
        transform: translateY(-2px);
        box-shadow: 0 4px 20px rgba(59, 130, 246, 0.2);
      }
      .profile-btn.active {
        background: rgba(59, 130, 246, 0.15);
        box-shadow: 0 0 20px rgba(59, 130, 246, 0.3);
      }
      .profile-btn.active .profile-icon {
        color: #3b82f6;
      }
      .result-value {
        background: linear-gradient(
          135deg,
          rgba(59, 130, 246, 0.1),
          rgba(59, 130, 246, 0.05)
        );
        border: 1px solid rgba(59, 130, 246, 0.3);
        transition: all 0.3s ease;
      }
      .result-value:hover {
        border-color: #3b82f6;
        box-shadow: 0 0 15px rgba(59, 130, 246, 0.15);
      }
      .input-field {
        background: rgba(17, 24, 39, 0.8);
        border: 1px solid rgba(55, 65, 81, 0.6);
        transition: all 0.2s ease;
      }
      .input-field:focus {
        border-color: #3b82f6;
        box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.15);
        outline: none;
      }
      .fade-in {
        animation: fadeIn 0.4s ease-out;
      }
      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: translateY(10px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }
      .svg-diagram {
        filter: drop-shadow(0 0 8px rgba(59, 130, 246, 0.2));
      }
      .search-dropdown {
        max-height: 280px;
        overflow-y: auto;
        scrollbar-width: thin;
        scrollbar-color: #3b82f6 transparent;
      }
      .search-dropdown::-webkit-scrollbar {
        width: 6px;
      }
      .search-dropdown::-webkit-scrollbar-track {
        background: transparent;
      }
      .search-dropdown::-webkit-scrollbar-thumb {
        background: #3b82f6;
        border-radius: 3px;
      }
      .dropdown-item {
        transition: all 0.15s ease;
      }
      .dropdown-item:hover,
      .dropdown-item.highlighted {
        background: rgba(59, 130, 246, 0.15);
        color: #3b82f6;
      }
      .prop-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
        gap: 0.75rem;
      }
      .prop-card {
        background: rgba(17, 24, 39, 0.6);
        border: 1px solid rgba(55, 65, 81, 0.4);
        border-radius: 0.75rem;
        padding: 0.75rem 1rem;
        transition: all 0.2s ease;
      }
      .prop-card:hover {
        border-color: rgba(59, 130, 246, 0.4);
        background: rgba(59, 130, 246, 0.05);
      }
    </style>
  </head>
  <body
    class="bg-gray-50 dark:bg-bim-dark text-gray-900 dark:text-gray-300 font-sans antialiased selection:bg-blue-500 selection:text-white"
  >
    <!-- Navigation -->
    <nav
      class="fixed w-full z-50 glass-nav border-b border-gray-200 dark:border-gray-800"
    >
      <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <div class="flex items-center justify-between h-16">
          <a href="../index.html" class="flex-shrink-0 flex items-center group">
            <i
              class="fa-solid fa-arrow-left text-gray-400 group-hover:text-bim-blue mr-3 transition-colors"
            ></i>
            <i class="fa-solid fa-layer-group text-bim-blue text-2xl mr-2"></i>
            <span class="font-bold text-xl text-gray-900 dark:text-white"
              >Andrés Gallo P<span class="text-bim-blue">.BIM</span></span
            >
          </a>
          <div class="hidden md:flex items-center space-x-2">
            <a
              href="index.html"
              class="text-gray-500 hover:text-bim-blue text-sm transition-colors"
              ><i class="fa-solid fa-toolbox mr-1"></i> Tools</a
            >
            <span class="text-gray-600">›</span>
            <span class="text-bim-blue text-sm font-semibold"
              >Catálogo ICHA</span
            >
          </div>
        </div>
      </div>
    </nav>

    <!-- Hero Section -->
    <section class="pt-24 pb-8 relative overflow-hidden">
      <div
        class="absolute top-0 left-0 w-full h-full overflow-hidden -z-10 opacity-10"
      >
        <svg width="100%" height="100%" xmlns="http://www.w3.org/2000/svg">
          <defs>
            <pattern
              id="grid"
              width="40"
              height="40"
              patternUnits="userSpaceOnUse"
            >
              <path
                d="M 40 0 L 0 0 0 40"
                fill="none"
                stroke="#3b82f6"
                stroke-width="0.5"
              />
            </pattern>
          </defs>
          <rect width="100%" height="100%" fill="url(#grid)" />
        </svg>
      </div>
      <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <div class="text-center mb-8">
          <div
            class="inline-block mb-4 px-3 py-1 rounded-full bg-blue-900/30 border border-blue-800 text-bim-blue text-sm font-semibold tracking-wide"
          >
            <i class="fa-solid fa-database mr-1"></i> CATÁLOGO ICHA — NORMA
            CHILENA
          </div>
          <h1
            class="text-3xl md:text-5xl font-extrabold text-white tracking-tight mb-4"
          >
            Catálogo de <span class="text-bim-blue">Perfiles ICHA</span>
          </h1>
          <p class="max-w-2xl mx-auto text-gray-400 text-lg">
            Selecciona perfiles del catálogo ICHA con todas sus propiedades
            mecánicas precargadas. Arma tu lista de materiales y exporta a
            Excel.
          </p>
        </div>
      </div>
    </section>

    <!-- Profile Type Selector -->
    <section class="pb-6">
      <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <h2
          class="text-sm font-bold text-gray-500 uppercase tracking-wider mb-4"
        >
          <i class="fa-solid fa-shapes mr-2"></i>Selecciona la serie
        </h2>
        <div
          class="grid grid-cols-3 sm:grid-cols-4 md:grid-cols-7 lg:grid-cols-13 gap-2"
          id="series-selector"
        >
          <!-- Populated by JS -->
        </div>
      </div>
    </section>

    <!-- Main Calculator Section -->
    <section class="py-6">
      <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <div class="grid grid-cols-1 lg:grid-cols-[1.1fr_0.7fr_1.2fr] gap-6">
          <!-- Left: SVG Diagram -->
          <div
            class="glass-card rounded-xl p-6 flex flex-col items-center justify-center min-h-[350px]"
            id="diagram-panel"
          >
            <h3
              class="text-sm font-bold text-gray-500 uppercase tracking-wider mb-4 self-start"
            >
              <i class="fa-solid fa-vector-square mr-2"></i>Sección Transversal
            </h3>
            <div
              id="svg-container"
              class="flex-1 flex items-center justify-center w-full svg-diagram"
            >
              <div class="text-center text-gray-600">
                <i class="fa-solid fa-shapes text-4xl mb-3 block"></i>
                <p class="text-sm">Selecciona un perfil</p>
              </div>
            </div>
            <div id="profile-designation" class="mt-4 text-center">
              <span
                class="text-2xl font-extrabold text-white"
                id="designation-text"
                >—</span
              >
            </div>
          </div>

          <!-- Center: Search & Select -->
          <div class="glass-card rounded-xl p-6" id="search-panel">
            <h3
              class="text-sm font-bold text-gray-500 uppercase tracking-wider mb-4"
            >
              <i class="fa-solid fa-magnifying-glass mr-2"></i>Buscar Perfil
            </h3>
            <div class="relative mb-4">
              <input
                type="text"
                id="profile-search"
                placeholder="Escribe para buscar... (ej: IN 20)"
                class="input-field w-full px-4 py-3 pr-10 rounded-lg text-white text-sm"
                autocomplete="off"
              />
              <i
                class="fa-solid fa-search absolute right-3 top-3.5 text-gray-500 text-sm"
              ></i>
            </div>
            <div
              id="search-results"
              class="search-dropdown rounded-lg border border-gray-700/50 hidden"
            >
              <!-- Populated by JS -->
            </div>

            <!-- Selected Profile Display -->
            <div id="selected-profile-display" class="mt-4 hidden fade-in">
              <div class="result-value rounded-xl p-5 text-center">
                <div
                  class="text-xs text-gray-500 uppercase tracking-wider mb-1"
                >
                  Perfil Seleccionado
                </div>
                <span
                  class="text-2xl font-extrabold text-white"
                  id="selected-profile-name"
                  >—</span
                >
                <div class="mt-2 flex items-center justify-center gap-4">
                  <span class="text-sm text-gray-400"
                    >Peso:
                    <span class="text-bim-blue font-bold" id="selected-weight"
                      >—</span
                    >
                    kg/m</span
                  >
                  <span class="text-sm text-gray-400"
                    >Área:
                    <span class="text-white font-bold" id="selected-area"
                      >—</span
                    >
                    cm²</span
                  >
                </div>
              </div>
            </div>

            <!-- Add to List Controls -->
            <div
              class="mt-6 pt-4 border-t border-gray-700/50"
              id="add-controls"
              style="display: none"
            >
              <label class="text-xs font-semibold text-gray-400 mb-2 block"
                >Agregar a la Lista</label
              >
              <div class="flex flex-wrap gap-2 items-stretch">
                <!-- Marca -->
                <div class="relative flex-[2] min-w-[80px]">
                  <input
                    type="text"
                    id="list-mark"
                    placeholder="Marca"
                    class="input-field w-full px-3 py-2.5 rounded-lg text-white text-sm text-center"
                  />
                  <span class="absolute right-2 top-3 text-[10px] text-gray-500"
                    ><i class="fa-solid fa-tag"></i>
                  </span>
                </div>
                <!-- Largo -->
                <div class="relative flex-none w-[80px]">
                  <input
                    type="number"
                    id="list-len"
                    value="6"
                    min="0.1"
                    step="0.1"
                    class="input-field w-full px-3 pr-7 py-2.5 rounded-lg text-white font-bold text-center text-sm"
                  />
                  <span
                    class="absolute right-2 top-3 text-[10px] text-gray-500 font-medium"
                    >m</span
                  >
                </div>
                <!-- Cantidad -->
                <div class="relative flex-none w-[80px]">
                  <input
                    type="number"
                    id="list-qty"
                    value="1"
                    min="1"
                    class="input-field w-full px-3 pr-7 py-2.5 rounded-lg text-white font-bold text-center text-sm"
                  />
                  <span
                    class="absolute right-2 top-3 text-[10px] text-gray-500 font-medium"
                    >un.</span
                  >
                </div>
                <!-- Button -->
                <button
                  id="btn-add-list"
                  class="bg-bim-blue hover:bg-blue-600 text-white font-bold py-2.5 px-5 rounded-lg transition-colors flex items-center justify-center gap-2 group text-sm whitespace-nowrap"
                >
                  <i
                    class="fa-solid fa-plus group-hover:rotate-90 transition-transform text-sm"
                  ></i>
                  <span>+ Agregar</span>
                </button>
              </div>
            </div>
          </div>

          <!-- Right: Properties -->
          <div class="glass-card rounded-xl p-6" id="properties-panel">
            <h3
              class="text-sm font-bold text-gray-500 uppercase tracking-wider mb-4"
            >
              <i class="fa-solid fa-table-list mr-2"></i>Propiedades Mecánicas
            </h3>
            <div id="properties-grid" class="prop-grid">
              <div
                class="prop-card col-span-full text-center py-12 text-gray-600"
              >
                <i class="fa-solid fa-arrow-left text-3xl mb-3 block"></i>
                <p class="text-sm">
                  Selecciona una serie y luego un perfil para ver sus
                  propiedades
                </p>
              </div>
            </div>
          </div>
        </div>

        <!-- Profile List Summary Section -->
        <div class="mt-8 hidden" id="summary-section">
          <div class="glass-card rounded-xl p-6 overflow-hidden mb-6">
            <div class="flex items-center justify-between mb-4">
              <h3
                class="text-sm font-bold text-gray-500 uppercase tracking-wider"
              >
                <i class="fa-solid fa-list-check mr-2"></i>Resumen de Perfiles
                Seleccionados
              </h3>
              <div class="flex items-center gap-3">
                <button
                  onclick="exportToExcel()"
                  class="text-xs bg-green-600 hover:bg-green-500 text-white px-3 py-1.5 rounded-lg transition-all hover:-translate-y-0.5 shadow-lg shadow-green-900/30 flex items-center gap-1.5 font-bold"
                >
                  <i class="fa-solid fa-file-excel"></i> Exportar Excel
                </button>
                <button
                  id="btn-clear-list"
                  class="text-xs text-red-400 hover:text-red-300 transition-colors flex items-center gap-1"
                >
                  <i class="fa-solid fa-trash-can"></i> Limpiar Todo
                </button>
              </div>
            </div>

            <div class="overflow-x-auto">
              <table class="w-full text-left border-collapse">
                <thead>
                  <tr
                    class="border-b border-gray-700 text-xs text-gray-400 uppercase tracking-wider"
                  >
                    <th class="py-3 px-4 font-semibold text-left">Marca</th>
                    <th class="py-3 px-4 font-semibold text-center w-16">
                      Cant.
                    </th>
                    <th class="py-3 px-4 font-semibold">Perfil</th>
                    <th class="py-3 px-4 font-semibold text-right">
                      Largo <span class="text-gray-600 normal-case">(m)</span>
                    </th>
                    <th class="py-3 px-4 font-semibold text-right">
                      Peso Unit.
                      <span class="text-gray-600 normal-case">(kg/m)</span>
                    </th>
                    <th class="py-3 px-4 font-semibold text-right">
                      Peso Total
                      <span class="text-gray-600 normal-case">(kg)</span>
                    </th>
                    <th class="py-3 px-4 font-semibold text-center w-16"></th>
                  </tr>
                </thead>
                <tbody
                  id="profile-list-body"
                  class="text-sm text-gray-300 divide-y divide-gray-800"
                >
                  <!-- Populated by JS -->
                </tbody>
                <tfoot class="bg-gray-800/30">
                  <tr class="font-bold text-white border-t border-gray-600">
                    <td class="py-4 px-4" colspan="4">TOTALES:</td>
                    <td
                      class="py-4 px-4 text-right transform translate-x-3 text-gray-500"
                    >
                      —
                    </td>
                    <td
                      class="py-4 px-4 text-right text-bim-blue text-lg"
                      id="grand-total-weight"
                    >
                      0.00
                      <span class="text-xs text-gray-500 font-medium ml-1"
                        >kg</span
                      >
                    </td>
                    <td></td>
                  </tr>
                </tfoot>
              </table>
            </div>
          </div>
        </div>

        <!-- Classification by Nominal Weight -->
        <div class="mt-6 hidden" id="classification-section">
          <div class="glass-card rounded-xl p-6 overflow-hidden mb-6">
            <div class="flex items-center justify-between mb-4 flex-wrap gap-3">
              <h3
                class="text-sm font-bold text-gray-500 uppercase tracking-wider"
              >
                <i class="fa-solid fa-weight-hanging mr-2"></i>Clasificación por
                Nominal Weight
              </h3>
              <div class="flex items-center gap-2">
                <label class="text-xs text-gray-400" for="conn-pct"
                  >Conexiones:</label
                >
                <input
                  type="number"
                  id="conn-pct"
                  value="10"
                  min="0"
                  max="100"
                  step="1"
                  class="w-16 bg-gray-800 border border-gray-600 rounded px-2 py-1 text-sm text-white text-center focus:border-bim-blue focus:outline-none"
                  onchange="updateClassification()"
                  oninput="updateClassification()"
                />
                <span class="text-xs text-gray-500">%</span>
              </div>
            </div>
            <div class="overflow-x-auto">
              <table class="w-full text-left border-collapse">
                <thead>
                  <tr
                    class="border-b border-gray-700 text-xs text-gray-400 uppercase tracking-wider"
                  >
                    <th class="py-3 px-4 font-semibold text-left">
                      Descripción
                    </th>
                    <th class="py-3 px-4 font-semibold text-right w-24">
                      Unidad
                    </th>
                    <th class="py-3 px-4 font-semibold text-right w-32">
                      Cantidad
                    </th>
                  </tr>
                </thead>
                <tbody id="classification-body" class="text-sm text-gray-300">
                  <!-- Populated by JS -->
                </tbody>
              </table>
            </div>
            <div
              class="mt-4 pt-3 border-t border-gray-600 flex items-center justify-between"
            >
              <span class="text-sm font-bold text-white"
                >Total Acero (con conexiones):</span
              >
              <span
                class="text-lg font-extrabold text-bim-blue"
                id="classification-total"
                >0.00 <span class="text-xs text-gray-500">kg</span></span
              >
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- Footer -->
    <footer class="py-8 border-t border-gray-800 mt-12">
      <div class="max-w-7xl mx-auto px-4 text-center">
        <p class="text-gray-500 text-sm">
          &copy; 2026 Andrés Gallo P. — Herramientas para Proyectistas
          Estructurales
        </p>
      </div>
    </footer>

    <script src="icha_data.js"></script>
    <script>
      // ==================== STATE ====================
      let currentSeries = null;
      let selectedProfile = null;
      const profileList = [];
      let highlightedIndex = -1;

      // ==================== PROPERTY LABELS ====================
      const PROP_LABELS = {
        weight: {
          label: "Peso Lineal",
          unit: "kg/m",
          icon: "fa-weight-hanging",
        },
        A_cm2: { label: "Área Sección", unit: "cm²", icon: "fa-vector-square" },
        B_mm: { label: "Ancho (B)", unit: "mm", icon: "fa-arrows-left-right" },
        e_mm: { label: "Espesor ala (e)", unit: "mm", icon: "fa-ruler" },
        t_mm: { label: "Espesor alma (t)", unit: "mm", icon: "fa-ruler" },
        C_mm: { label: "Labio (C)", unit: "mm", icon: "fa-ruler" },
        Ix_cm4: { label: "Ix", unit: "cm⁴", icon: "fa-rotate" },
        Wx_cm3: { label: "Wx", unit: "cm³", icon: "fa-cube" },
        ix_cm: { label: "ix", unit: "cm", icon: "fa-circle-dot" },
        Iy_cm4: { label: "Iy", unit: "cm⁴", icon: "fa-rotate" },
        Wy_cm3: { label: "Wy", unit: "cm³", icon: "fa-cube" },
        iy_cm: { label: "iy", unit: "cm", icon: "fa-circle-dot" },
        xy_cm: { label: "x=y", unit: "cm", icon: "fa-crosshairs" },
        x_cm: { label: "x", unit: "cm", icon: "fa-crosshairs" },
        y_cm: { label: "y", unit: "cm", icon: "fa-crosshairs" },
        X_cm: { label: "X (cg)", unit: "cm", icon: "fa-crosshairs" },
        iu_cm: { label: "i (eje U)", unit: "cm", icon: "fa-circle-dot" },
        iv_cm: { label: "i (eje V)", unit: "cm", icon: "fa-circle-dot" },
      };

      // ==================== SERIES SELECTOR ====================
      function renderSeriesSelector() {
        const container = document.getElementById("series-selector");
        container.innerHTML = "";
        for (const [key, series] of Object.entries(ICHA_CATALOG)) {
          const btn = document.createElement("button");
          btn.className =
            "profile-btn glass-card rounded-xl p-3 flex flex-col items-center justify-center gap-1 cursor-pointer border border-transparent";
          btn.innerHTML = `
            <i class="${series.icon} profile-icon text-gray-400 text-lg"></i>
            <span class="text-xs font-bold text-gray-400 leading-tight text-center">${key.replace("_desig", "")}</span>
            <span class="text-[10px] text-gray-600 leading-tight text-center truncate w-full">${series.name.split("(")[0].trim()}</span>
          `;
          btn.addEventListener("click", () => selectSeries(key));
          container.appendChild(btn);
        }
      }

      function selectSeries(key) {
        currentSeries = key;
        selectedProfile = null;
        highlightedIndex = -1;

        // Update buttons
        document
          .querySelectorAll("#series-selector .profile-btn")
          .forEach((btn, i) => {
            const seriesKey = Object.keys(ICHA_CATALOG)[i];
            btn.classList.toggle("active", seriesKey === key);
          });

        // Reset search
        const searchInput = document.getElementById("profile-search");
        searchInput.value = "";
        searchInput.placeholder = `Buscar en ${ICHA_CATALOG[key].name}...`;
        searchInput.focus();

        // Show all profiles for this series
        showSearchResults("");

        // Hide selected profile
        document
          .getElementById("selected-profile-display")
          .classList.add("hidden");
        document.getElementById("add-controls").style.display = "none";

        // Reset properties
        document.getElementById("properties-grid").innerHTML = `
          <div class="prop-card col-span-full text-center py-8 text-gray-600">
            <i class="fa-solid fa-search text-2xl mb-2 block"></i>
            <p class="text-sm">${ICHA_CATALOG[key].profiles.length} perfiles disponibles — busca o selecciona uno</p>
          </div>
        `;
      }

      // ==================== SEARCH ====================
      function showSearchResults(query) {
        if (!currentSeries) return;
        const container = document.getElementById("search-results");
        const profiles = ICHA_CATALOG[currentSeries].profiles;
        const q = query.toLowerCase().replace(/\s+/g, "");

        const filtered = profiles.filter((p) => {
          const desig = p.designation.toLowerCase().replace(/\s+/g, "");
          return desig.includes(q);
        });

        if (filtered.length === 0) {
          container.innerHTML = `<div class="p-4 text-center text-gray-500 text-sm">No se encontraron perfiles</div>`;
          container.classList.remove("hidden");
          return;
        }

        container.innerHTML = filtered
          .map(
            (p, i) => `
          <div class="dropdown-item px-4 py-2.5 cursor-pointer text-sm flex items-center justify-between border-b border-gray-800/50 last:border-0"
               data-index="${profiles.indexOf(p)}" data-filtered-index="${i}">
            <span class="font-semibold text-white">${p.designation}</span>
            <span class="text-xs text-gray-500">${p.weight} kg/m</span>
          </div>`,
          )
          .join("");

        container.classList.remove("hidden");
        highlightedIndex = -1;

        // Add click handlers
        container.querySelectorAll(".dropdown-item").forEach((item) => {
          item.addEventListener("click", () => {
            const idx = parseInt(item.dataset.index);
            selectProfile(profiles[idx]);
            container.classList.add("hidden");
          });
        });
      }

      // ==================== SELECT PROFILE ====================
      function selectProfile(profile) {
        selectedProfile = profile;
        const searchInput = document.getElementById("profile-search");
        searchInput.value = profile.designation;

        // Show selected profile
        document
          .getElementById("selected-profile-display")
          .classList.remove("hidden");
        document.getElementById("selected-profile-name").textContent =
          profile.designation;
        document.getElementById("selected-weight").textContent =
          profile.weight.toFixed(1);
        document.getElementById("selected-area").textContent = (
          profile.A_cm2 || 0
        ).toFixed(1);

        // Show add controls
        document.getElementById("add-controls").style.display = "block";

        // Render properties
        renderProperties(profile);

        // Render SVG cross-section
        renderSvgDiagram(profile);
      }

      function renderProperties(profile) {
        const grid = document.getElementById("properties-grid");
        let html = "";

        // Priority order for properties
        const order = [
          "weight",
          "A_cm2",
          "B_mm",
          "e_mm",
          "t_mm",
          "C_mm",
          "Ix_cm4",
          "Wx_cm3",
          "ix_cm",
          "Iy_cm4",
          "Wy_cm3",
          "iy_cm",
          "xy_cm",
          "x_cm",
          "y_cm",
          "X_cm",
          "iu_cm",
          "iv_cm",
        ];

        for (const key of order) {
          if (profile[key] === undefined || profile[key] === null) continue;
          const meta = PROP_LABELS[key];
          if (!meta) continue;

          const isWeight = key === "weight";
          html += `
            <div class="prop-card ${isWeight ? "border-blue-500/30 bg-blue-500/5" : ""}">
              <div class="flex items-center gap-2 mb-1">
                <i class="fa-solid ${meta.icon} text-[10px] ${isWeight ? "text-bim-blue" : "text-gray-600"}"></i>
                <span class="text-xs text-gray-500 font-medium">${meta.label}</span>
              </div>
              <div class="flex items-baseline gap-1">
                <span class="text-lg font-extrabold ${isWeight ? "text-bim-blue" : "text-white"}">${formatNumber(profile[key])}</span>
                <span class="text-[10px] text-gray-500">${meta.unit}</span>
              </div>
            </div>
          `;
        }

        grid.innerHTML =
          html ||
          `<div class="col-span-full text-center py-8 text-gray-500">Sin propiedades disponibles</div>`;
      }

      function formatNumber(n) {
        if (n === null || n === undefined) return "—";
        if (Math.abs(n) >= 10000) return n.toLocaleString("es-CL");
        if (Number.isInteger(n)) return n.toString();
        return n.toFixed(n < 10 ? 2 : 1);
      }

      // ==================== SVG CROSS-SECTION ====================
      const SZ = 240,
        CX = SZ / 2,
        CY = SZ / 2,
        PAD = 45;

      function dimLine(x1, y1, x2, y2, label, offset = 0, color = "#60a5fa") {
        const isV = Math.abs(x1 - x2) < 2;
        const ox = isV ? offset : 0,
          oy = isV ? 0 : offset;
        const mx = (x1 + x2) / 2 + ox,
          my = (y1 + y2) / 2 + oy;
        const tox = isV ? (offset > 0 ? 8 : -8) : 0;
        const toy = isV ? 0 : offset > 0 ? 12 : -6;
        const tx = Math.max(24, Math.min(SZ - 24, mx + tox));
        const ty = Math.max(10, Math.min(SZ - 4, my + toy));
        return `<line x1="${x1 + ox}" y1="${y1 + oy}" x2="${x2 + ox}" y2="${y2 + oy}" stroke="${color}" stroke-width="0.8" stroke-dasharray="3,2" opacity="0.7"/>
                <text x="${tx}" y="${ty}" fill="${color}" font-size="10" font-family="Inter" font-weight="600" text-anchor="middle">${label}</text>`;
      }

      function getHeightFromDesig(designation) {
        const m = designation.match(/(\d+)/);
        return m ? parseFloat(m[1]) * 10 : 300;
      }

      // H / I shape (IN, IP, HN, PH)
      function buildICHAHSvg(h, b, s, t) {
        const sc = Math.min((SZ - 2 * PAD) / h, (SZ - 2 * PAD) / b);
        const H = h * sc,
          B = b * sc,
          S = Math.max(s * sc, 4),
          T = Math.max(t * sc, 4);
        const x = CX,
          y = CY;
        const shape = `<polygon points="${x - B / 2},${y - H / 2} ${x + B / 2},${y - H / 2} ${x + B / 2},${y - H / 2 + T} ${x + S / 2},${y - H / 2 + T} ${x + S / 2},${y + H / 2 - T} ${x + B / 2},${y + H / 2 - T} ${x + B / 2},${y + H / 2} ${x - B / 2},${y + H / 2} ${x - B / 2},${y + H / 2 - T} ${x - S / 2},${y + H / 2 - T} ${x - S / 2},${y - H / 2 + T} ${x - B / 2},${y - H / 2 + T}" fill="rgba(59,130,246,0.15)" stroke="#3b82f6" stroke-width="2"/>`;
        let dims = dimLine(
          x - B / 2,
          y - H / 2,
          x - B / 2,
          y + H / 2,
          `h=${h}`,
          -22,
        );
        dims += dimLine(
          x - B / 2,
          y + H / 2,
          x + B / 2,
          y + H / 2,
          `b=${b}`,
          18,
        );
        dims += `<text x="${x + S / 2 + 6}" y="${y + 4}" fill="#60a5fa" font-size="9" font-family="Inter" font-weight="600">t=${s}</text>`;
        dims += `<text x="${x + B / 2 + 6}" y="${y - H / 2 + T / 2 + 3}" fill="#60a5fa" font-size="9" font-family="Inter" font-weight="600">e=${t}</text>`;
        return `<svg viewBox="0 0 ${SZ} ${SZ}" class="w-full h-full max-w-[240px]">${shape}${dims}</svg>`;
      }

      // Channel C shape
      function buildICHACSvg(h, b, e, t) {
        const bVal = b || 80;
        const sc = Math.min((SZ - 2 * PAD) / h, (SZ - 2 * PAD) / (bVal * 2));
        const H = h * sc,
          B = bVal * sc,
          T = Math.max((t || e) * sc, 3);
        const x = CX,
          top = CY - H / 2;
        const pts = `${x - B},${top} ${x},${top} ${x},${top + T} ${x - B + T},${top + T} ${x - B + T},${top + H - T} ${x},${top + H - T} ${x},${top + H} ${x - B},${top + H}`;
        const shape = `<polygon points="${pts}" fill="rgba(59,130,246,0.15)" stroke="#3b82f6" stroke-width="2"/>`;
        let dims = dimLine(x + 4, top, x + 4, top + H, `h=${h}`, 14);
        dims += dimLine(x - B, top + H, x, top + H, `b=${bVal}`, 16);
        dims += `<text x="${x + 6}" y="${top + T + 12}" fill="#60a5fa" font-size="9" font-family="Inter" font-weight="600">e=${e || t}</text>`;
        return `<svg viewBox="0 0 ${SZ} ${SZ}" class="w-full h-full max-w-[240px]">${shape}${dims}</svg>`;
      }

      // Stiffened channel (CA)
      function buildICHACASvg(h, b, e, t, c) {
        const sc = Math.min(
          (SZ - 2 * PAD) / h,
          (SZ - 2 * PAD) / ((b || 80) * 2),
        );
        const H = h * sc,
          B = Math.max((b || 50) * sc, 8),
          T = Math.max((t || e) * sc, 3);
        const C = c ? Math.max(c * sc, 6) : 0;
        const left = CX - B / 2,
          top = CY - H / 2;
        let pts;
        if (C > 0) {
          pts = `${left},${top} ${left + B},${top} ${left + B},${top + C} ${left + B - T},${top + C} ${left + B - T},${top + T} ${left + T},${top + T} ${left + T},${top + H - T} ${left + B - T},${top + H - T} ${left + B - T},${top + H - C} ${left + B},${top + H - C} ${left + B},${top + H} ${left},${top + H}`;
        } else {
          pts = `${left},${top} ${left + B},${top} ${left + B},${top + T} ${left + T},${top + T} ${left + T},${top + H - T} ${left + B},${top + H - T} ${left + B},${top + H} ${left},${top + H}`;
        }
        const shape = `<polygon points="${pts}" fill="rgba(59,130,246,0.15)" stroke="#3b82f6" stroke-width="2"/>`;
        let dims = dimLine(
          left + B + 4,
          top,
          left + B + 4,
          top + H,
          `h=${h}`,
          16,
        );
        dims += dimLine(left, top + H, left + B, top + H, `b=${b || 50}`, 16);
        dims += `<text x="${left + B + 6}" y="${top + T / 2 + 3}" fill="#60a5fa" font-size="9" font-family="Inter" font-weight="600">e=${e || t}</text>`;
        if (C > 0)
          dims += `<text x="${left + B + 6}" y="${top + H - C / 2 + 3}" fill="#60a5fa" font-size="9" font-family="Inter" font-weight="600">c=${c}</text>`;
        return `<svg viewBox="0 0 ${SZ} ${SZ}" class="w-full h-full max-w-[240px]">${shape}${dims}</svg>`;
      }

      // Angle L shape
      function buildICHALSvg(h, b, e) {
        const bVal = b || h;
        const maxD = Math.max(h, bVal);
        const sc = (SZ - 2 * PAD) / maxD;
        const H = h * sc,
          B = bVal * sc,
          T = Math.max(e * sc, 3);
        const x = CX - B / 2,
          top = CY - H / 2;
        const pts = `${x},${top} ${x + T},${top} ${x + T},${top + H - T} ${x + B},${top + H - T} ${x + B},${top + H} ${x},${top + H}`;
        const shape = `<polygon points="${pts}" fill="rgba(59,130,246,0.15)" stroke="#3b82f6" stroke-width="2"/>`;
        let dims = dimLine(x, top, x, top + H, `h=${h}`, -20);
        dims += dimLine(x, top + H, x + B, top + H, `b=${bVal}`, 16);
        dims += `<text x="${x + T + 6}" y="${top + 20}" fill="#60a5fa" font-size="9" font-family="Inter" font-weight="600">e=${e}</text>`;
        return `<svg viewBox="0 0 ${SZ} ${SZ}" class="w-full h-full max-w-[240px]">${shape}${dims}</svg>`;
      }

      // Double angle TL shape
      function buildICHATLSvg(h, b, e) {
        const bVal = b || h;
        const sc =
          Math.min((SZ - 2 * PAD) / h, (SZ - 2 * PAD) / (bVal * 2)) * 0.85;
        const H = h * sc,
          B = bVal * sc,
          T = Math.max(e * sc, 3);
        const gap = 6;
        // Left angle (mirrored)
        const lx = CX - gap / 2,
          top = CY - H / 2;
        const lPts = `${lx},${top} ${lx - T},${top} ${lx - T},${top + H - T} ${lx - B},${top + H - T} ${lx - B},${top + H} ${lx},${top + H}`;
        // Right angle
        const rx = CX + gap / 2;
        const rPts = `${rx},${top} ${rx + T},${top} ${rx + T},${top + H - T} ${rx + B},${top + H - T} ${rx + B},${top + H} ${rx},${top + H}`;
        const shape = `<polygon points="${lPts}" fill="rgba(59,130,246,0.15)" stroke="#3b82f6" stroke-width="2"/>
                        <polygon points="${rPts}" fill="rgba(59,130,246,0.15)" stroke="#3b82f6" stroke-width="2"/>`;
        let dims = dimLine(lx - B, top, lx - B, top + H, `h=${h}`, -18);
        dims += dimLine(rx, top + H, rx + B, top + H, `b=${bVal}`, 16);
        dims += `<text x="${rx + T + 6}" y="${top + 14}" fill="#60a5fa" font-size="9" font-family="Inter" font-weight="600">e=${e}</text>`;
        return `<svg viewBox="0 0 ${SZ} ${SZ}" class="w-full h-full max-w-[240px]">${shape}${dims}</svg>`;
      }

      // Cross angle XL shape
      function buildICHAXLSvg(h, b, e) {
        const bVal = b || h;
        const maxD = Math.max(h, bVal);
        const sc = ((SZ - 2 * PAD) / maxD) * 0.7;
        const H = h * sc,
          B = bVal * sc,
          T = Math.max(e * sc, 3);
        const gap = 6;
        const ax = CX - gap / 2,
          ay = CY - gap / 2;
        const aPts = `${ax},${ay} ${ax},${ay - H} ${ax - T},${ay - H} ${ax - T},${ay - T} ${ax - B},${ay - T} ${ax - B},${ay}`;
        const bx = CX + gap / 2,
          by = CY + gap / 2;
        const bPts = `${bx},${by} ${bx},${by + H} ${bx + T},${by + H} ${bx + T},${by + T} ${bx + B},${by + T} ${bx + B},${by}`;
        const shape = `<polygon points="${aPts}" fill="rgba(59,130,246,0.15)" stroke="#3b82f6" stroke-width="2" stroke-linejoin="round"/>
                        <polygon points="${bPts}" fill="rgba(59,130,246,0.15)" stroke="#3b82f6" stroke-width="2" stroke-linejoin="round"/>`;
        let dims = dimLine(ax - T, ay - H, ax - T, ay, `h=${h}`, -18);
        dims += dimLine(ax - B, ay, ax, ay, `b=${bVal}`, 16);
        dims += `<text x="${ax + 8}" y="${ay - H + 14}" fill="#60a5fa" font-size="9" font-family="Inter" font-weight="600">e=${e}</text>`;
        return `<svg viewBox="0 0 ${SZ} ${SZ}" class="w-full h-full max-w-[240px]">${shape}${dims}</svg>`;
      }

      // Double channel IC shape
      function buildICHAICSvg(h, b, e, t) {
        const bVal = b || 80;
        const sc =
          Math.min((SZ - 2 * PAD) / h, (SZ - 2 * PAD) / (bVal * 2)) * 0.9;
        const H = h * sc,
          B = bVal * sc,
          T = Math.max((t || e) * sc, 3);
        const gap = 4;
        const top = CY - H / 2;
        // Left channel (opening left)
        const lx = CX - gap / 2;
        const lPts = `${lx},${top} ${lx - B},${top} ${lx - B},${top + T} ${lx - T},${top + T} ${lx - T},${top + H - T} ${lx - B},${top + H - T} ${lx - B},${top + H} ${lx},${top + H}`;
        // Right channel (opening right)
        const rx = CX + gap / 2;
        const rPts = `${rx},${top} ${rx + B},${top} ${rx + B},${top + T} ${rx + T},${top + T} ${rx + T},${top + H - T} ${rx + B},${top + H - T} ${rx + B},${top + H} ${rx},${top + H}`;
        const shape = `<polygon points="${lPts}" fill="rgba(59,130,246,0.15)" stroke="#3b82f6" stroke-width="2"/>
                        <polygon points="${rPts}" fill="rgba(59,130,246,0.15)" stroke="#3b82f6" stroke-width="2"/>`;
        let dims = dimLine(rx + B + 4, top, rx + B + 4, top + H, `h=${h}`, 16);
        dims += dimLine(rx, top + H, rx + B, top + H, `b=${bVal}`, 16);
        dims += `<text x="${rx + T + 6}" y="${top + T + 12}" fill="#60a5fa" font-size="9" font-family="Inter" font-weight="600">e=${e || t}</text>`;
        return `<svg viewBox="0 0 ${SZ} ${SZ}" class="w-full h-full max-w-[240px]">${shape}${dims}</svg>`;
      }

      // Double stiffened channel ICA shape
      function buildICHAICASvg(h, b, e, t, c) {
        const bVal = b || 80;
        const sc =
          Math.min((SZ - 2 * PAD) / h, (SZ - 2 * PAD) / (bVal * 2)) * 0.9;
        const H = h * sc,
          B = Math.max(bVal * sc, 8),
          T = Math.max((t || e) * sc, 3);
        const C = c ? Math.max(c * sc, 6) : 0;
        const gap = 4;
        const top = CY - H / 2;
        // Left stiffened channel
        const lx = CX - gap / 2;
        let lPts;
        if (C > 0) {
          lPts = `${lx},${top} ${lx - B},${top} ${lx - B},${top + C} ${lx - B + T},${top + C} ${lx - B + T},${top + T} ${lx - T},${top + T} ${lx - T},${top + H - T} ${lx - B + T},${top + H - T} ${lx - B + T},${top + H - C} ${lx - B},${top + H - C} ${lx - B},${top + H} ${lx},${top + H}`;
        } else {
          lPts = `${lx},${top} ${lx - B},${top} ${lx - B},${top + T} ${lx - T},${top + T} ${lx - T},${top + H - T} ${lx - B},${top + H - T} ${lx - B},${top + H} ${lx},${top + H}`;
        }
        // Right stiffened channel (mirrored)
        const rx = CX + gap / 2;
        let rPts;
        if (C > 0) {
          rPts = `${rx},${top} ${rx + B},${top} ${rx + B},${top + C} ${rx + B - T},${top + C} ${rx + B - T},${top + T} ${rx + T},${top + T} ${rx + T},${top + H - T} ${rx + B - T},${top + H - T} ${rx + B - T},${top + H - C} ${rx + B},${top + H - C} ${rx + B},${top + H} ${rx},${top + H}`;
        } else {
          rPts = `${rx},${top} ${rx + B},${top} ${rx + B},${top + T} ${rx + T},${top + T} ${rx + T},${top + H - T} ${rx + B},${top + H - T} ${rx + B},${top + H} ${rx},${top + H}`;
        }
        const shape = `<polygon points="${lPts}" fill="rgba(59,130,246,0.15)" stroke="#3b82f6" stroke-width="2"/>
                        <polygon points="${rPts}" fill="rgba(59,130,246,0.15)" stroke="#3b82f6" stroke-width="2"/>`;
        let dims = dimLine(rx + B + 4, top, rx + B + 4, top + H, `h=${h}`, 16);
        dims += dimLine(rx, top + H, rx + B, top + H, `b=${bVal}`, 16);
        return `<svg viewBox="0 0 ${SZ} ${SZ}" class="w-full h-full max-w-[240px]">${shape}${dims}</svg>`;
      }

      // Box (Cajón) shape
      function buildICHABoxSvg(h, b, e) {
        const sc = Math.min((SZ - 2 * PAD) / h, (SZ - 2 * PAD) / b);
        const H = h * sc,
          B = b * sc,
          T = Math.max(e * sc, 3);
        const x = CX - B / 2,
          y = CY - H / 2;
        const outer = `<rect x="${x}" y="${y}" width="${B}" height="${H}" fill="none" stroke="#3b82f6" stroke-width="2" rx="3"/>`;
        const inner = `<rect x="${x + T}" y="${y + T}" width="${B - 2 * T}" height="${H - 2 * T}" fill="rgba(11,18,32,0.9)" stroke="#3b82f6" stroke-width="1.5" stroke-dasharray="4,2" rx="1"/>`;
        const fill = `<rect x="${x}" y="${y}" width="${B}" height="${H}" fill="rgba(59,130,246,0.12)" rx="3"/>`;
        const innerClear = `<rect x="${x + T}" y="${y + T}" width="${B - 2 * T}" height="${H - 2 * T}" fill="rgba(11,18,32,0.85)" rx="1"/>`;
        let dims = dimLine(x, y, x, y + H, `h=${h}`, -22);
        dims += dimLine(x, y + H, x + B, y + H, `b=${b}`, 16);
        dims += `<text x="${CX}" y="${CY + 4}" fill="#60a5fa" font-size="10" font-family="Inter" font-weight="600" text-anchor="middle">e=${e}</text>`;
        return `<svg viewBox="0 0 ${SZ} ${SZ}" class="w-full h-full max-w-[240px]">${fill}${innerClear}${outer}${inner}${dims}</svg>`;
      }

      // Map series to SVG builder
      function renderSvgDiagram(profile) {
        const container = document.getElementById("svg-container");
        const desigText = document.getElementById("designation-text");
        desigText.textContent = profile.designation;

        const h = getHeightFromDesig(profile.designation);
        const b = profile.B_mm || h;
        const e = profile.e_mm || 8;
        const t = profile.t_mm || e;
        const c = profile.C_mm || 0;

        let svg = "";
        const series = currentSeries;

        if (["IN", "IP", "HN", "PH"].includes(series)) {
          svg = buildICHAHSvg(h, b, t, e);
        } else if (series === "C") {
          svg = buildICHACSvg(h, b, t, e);
        } else if (series === "CA") {
          svg = buildICHACASvg(h, b, t, e, c);
        } else if (series === "IC") {
          svg = buildICHAICSvg(h, b, t, e);
        } else if (series === "ICA") {
          svg = buildICHAICASvg(h, b, t, e, c);
        } else if (series === "L" || series === "L_desig") {
          svg = buildICHALSvg(h, b, e);
        } else if (series === "TL") {
          svg = buildICHATLSvg(h, b, e);
        } else if (series === "XL") {
          svg = buildICHAXLSvg(h, b, e);
        } else if (series === "CAJON") {
          svg = buildICHABoxSvg(h, b, e);
        } else {
          // Fallback: generic H shape
          svg = buildICHAHSvg(h, b, t, e);
        }

        container.innerHTML = svg;
      }

      function addToList() {
        if (!selectedProfile) return;
        const mark = document.getElementById("list-mark").value || "—";
        const len = parseFloat(document.getElementById("list-len").value) || 6;
        const qty = parseInt(document.getElementById("list-qty").value) || 1;

        profileList.push({
          mark,
          qty,
          designation: selectedProfile.designation,
          length: len,
          unitWeight: selectedProfile.weight,
          totalWeight: qty * len * selectedProfile.weight,
        });

        renderProfileList();
        document.getElementById("list-mark").value = "";
      }

      function removeFromList(index) {
        profileList.splice(index, 1);
        renderProfileList();
      }

      function clearList() {
        profileList.length = 0;
        renderProfileList();
      }

      function renderProfileList() {
        const tbody = document.getElementById("profile-list-body");
        const section = document.getElementById("summary-section");
        const classSection = document.getElementById("classification-section");

        if (profileList.length === 0) {
          section.classList.add("hidden");
          classSection.classList.add("hidden");
          return;
        }
        section.classList.remove("hidden");
        classSection.classList.remove("hidden");

        let totalWeight = 0;
        tbody.innerHTML = profileList
          .map((item, i) => {
            totalWeight += item.totalWeight;
            const bgClass = i % 2 === 0 ? "" : "bg-gray-800/20";
            return `
              <tr class="${bgClass} hover:bg-gray-700/30 transition-colors">
                <td class="py-3 px-4 font-semibold text-white">${item.mark}</td>
                <td class="py-3 px-4 text-center font-bold">${item.qty}</td>
                <td class="py-3 px-4 text-bim-blue font-semibold">${item.designation}</td>
                <td class="py-3 px-4 text-right">${item.length.toFixed(1)}</td>
                <td class="py-3 px-4 text-right">${item.unitWeight.toFixed(2)}</td>
                <td class="py-3 px-4 text-right font-bold text-white">${item.totalWeight.toFixed(2)}</td>
                <td class="py-3 px-4 text-center">
                  <button onclick="removeFromList(${i})" class="text-red-500 hover:text-red-400 transition-colors">
                    <i class="fa-solid fa-xmark"></i>
                  </button>
                </td>
              </tr>`;
          })
          .join("");

        document.getElementById("grand-total-weight").innerHTML =
          `${totalWeight.toFixed(2)} <span class="text-xs text-gray-500 font-medium ml-1">kg</span>`;

        updateClassification();
      }

      // ==================== CLASSIFICATION ====================
      function updateClassification() {
        const categories = [
          { name: "Perfiles Livianos (< 25 kg/m)", min: 0, max: 25 },
          { name: "Perfiles Medios (25 – 50 kg/m)", min: 25, max: 50 },
          { name: "Perfiles Pesados (50 – 100 kg/m)", min: 50, max: 100 },
          {
            name: "Perfiles Extra Pesados (≥ 100 kg/m)",
            min: 100,
            max: Infinity,
          },
        ];

        const catWeights = categories.map(() => 0);
        profileList.forEach((item) => {
          for (let i = 0; i < categories.length; i++) {
            if (
              item.unitWeight >= categories[i].min &&
              item.unitWeight < categories[i].max
            ) {
              catWeights[i] += item.totalWeight;
              break;
            }
          }
        });

        const tbody = document.getElementById("classification-body");
        const totalWeight = catWeights.reduce((a, b) => a + b, 0);
        const connPct =
          parseFloat(document.getElementById("conn-pct").value) || 10;
        const connection = totalWeight * (connPct / 100);
        const grandTotal = totalWeight + connection;

        tbody.innerHTML =
          categories
            .map((cat, i) => {
              const bgClass = i % 2 === 0 ? "" : "bg-gray-800/20";
              return `
              <tr class="${bgClass} border-b border-gray-800">
                <td class="py-3 px-4">${cat.name}</td>
                <td class="py-3 px-4 text-right text-gray-500">kg</td>
                <td class="py-3 px-4 text-right font-bold text-white">${catWeights[i].toFixed(2)}</td>
              </tr>`;
            })
            .join("") +
          `<tr class="border-b border-gray-800 bg-gray-800/20">
            <td class="py-3 px-4 font-semibold text-yellow-400">+ ${connPct}% Conexiones</td>
            <td class="py-3 px-4 text-right text-gray-500">kg</td>
            <td class="py-3 px-4 text-right font-bold text-yellow-400">${connection.toFixed(2)}</td>
          </tr>`;

        document.getElementById("classification-total").innerHTML =
          `${grandTotal.toFixed(2)} <span class="text-xs text-gray-500">kg</span>`;
      }

      // ==================== EXCEL EXPORT ====================
      function exportToExcel() {
        if (profileList.length === 0) return;
        const n = profileList.length;

        // ── Style palette ──
        const bd = {
          top: { style: "thin", color: { rgb: "BDD7EE" } },
          bottom: { style: "thin", color: { rgb: "BDD7EE" } },
          left: { style: "thin", color: { rgb: "BDD7EE" } },
          right: { style: "thin", color: { rgb: "BDD7EE" } },
        };
        const S = {
          title: {
            font: { bold: true, sz: 13, color: { rgb: "FFFFFF" } },
            fill: { fgColor: { rgb: "1F4E79" } },
            alignment: { horizontal: "center", vertical: "center" },
            border: bd,
          },
          head: {
            font: { bold: true, sz: 10, color: { rgb: "FFFFFF" } },
            fill: { fgColor: { rgb: "2E75B6" } },
            alignment: { horizontal: "center", vertical: "center" },
            border: bd,
          },
          l: {
            font: { sz: 10 },
            border: bd,
            alignment: { vertical: "center" },
          },
          c: {
            font: { sz: 10 },
            border: bd,
            alignment: { horizontal: "center", vertical: "center" },
          },
          r: {
            font: { sz: 10 },
            border: bd,
            alignment: { horizontal: "right", vertical: "center" },
            numFmt: "#,##0.00",
          },
          al: {
            font: { sz: 10 },
            fill: { fgColor: { rgb: "F2F7FB" } },
            border: bd,
            alignment: { vertical: "center" },
          },
          ac: {
            font: { sz: 10 },
            fill: { fgColor: { rgb: "F2F7FB" } },
            border: bd,
            alignment: { horizontal: "center", vertical: "center" },
          },
          ar: {
            font: { sz: 10 },
            fill: { fgColor: { rgb: "F2F7FB" } },
            border: bd,
            alignment: { horizontal: "right", vertical: "center" },
            numFmt: "#,##0.00",
          },
          tl: {
            font: { bold: true, sz: 11, color: { rgb: "1F4E79" } },
            fill: { fgColor: { rgb: "D6E4F0" } },
            border: bd,
            alignment: { vertical: "center" },
          },
          tc: {
            font: { bold: true, sz: 11, color: { rgb: "1F4E79" } },
            fill: { fgColor: { rgb: "D6E4F0" } },
            border: bd,
            alignment: { horizontal: "center", vertical: "center" },
          },
          tr: {
            font: { bold: true, sz: 11, color: { rgb: "1F4E79" } },
            fill: { fgColor: { rgb: "D6E4F0" } },
            border: bd,
            alignment: { horizontal: "right", vertical: "center" },
            numFmt: "#,##0.00",
          },
        };

        // ── Build data (AOA) ──
        const a = [];
        a.push(["CATÁLOGO ICHA — RESUMEN DE PERFILES", "", "", "", "", ""]);
        a.push(["", "", "", "", "", ""]);
        a.push([
          "Marca",
          "Cant.",
          "Perfil",
          "Largo (m)",
          "Peso Unit. (kg/m)",
          "Peso Total (kg)",
        ]);
        profileList.forEach((i) =>
          a.push([
            i.mark,
            i.qty,
            i.designation,
            i.length,
            i.unitWeight,
            i.totalWeight,
          ]),
        );
        const tw = profileList.reduce((s, i) => s + i.totalWeight, 0);
        a.push(["TOTAL", "", "", "", "", tw]);
        a.push(["", "", "", "", "", ""]);
        a.push(["", "", "", "", "", ""]);
        a.push(["CLASIFICACIÓN POR NOMINAL WEIGHT", "", "", "", "", ""]);
        a.push(["", "", "", "", "", ""]);
        a.push(["Descripción", "Unidad", "Cantidad"]);

        const categories = [
          { name: "Perfiles Livianos (< 25 kg/m)", min: 0, max: 25 },
          { name: "Perfiles Medios (25 – 50 kg/m)", min: 25, max: 50 },
          { name: "Perfiles Pesados (50 – 100 kg/m)", min: 50, max: 100 },
          {
            name: "Perfiles Extra Pesados (≥ 100 kg/m)",
            min: 100,
            max: Infinity,
          },
        ];

        const catWeights = categories.map(() => 0);
        profileList.forEach((item) => {
          for (let i = 0; i < categories.length; i++) {
            if (
              item.unitWeight >= categories[i].min &&
              item.unitWeight < categories[i].max
            ) {
              catWeights[i] += item.totalWeight;
              break;
            }
          }
        });

        const tb = catWeights.reduce((s, v) => s + v, 0);
        const connPct =
          parseFloat(document.getElementById("conn-pct").value) || 10;
        const cn = tb * (connPct / 100),
          tf = tb + cn;
        categories.forEach((cat, i) => {
          a.push([cat.name, "kg", catWeights[i]]);
        });
        a.push([`Conexiones Acero (+${connPct}%)`, "kg", cn]);
        a.push([""]);
        a.push(["TOTAL ACERO (con conexiones)", "kg", tf]);
        a.push(["", "ton", tf / 1000]);

        // ── Create worksheet ──
        const ws = XLSX.utils.aoa_to_sheet(a);
        ws["!cols"] = [
          { wch: 45 },
          { wch: 14 },
          { wch: 28 },
          { wch: 14 },
          { wch: 18 },
          { wch: 16 },
        ];
        ws["!merges"] = [
          { s: { r: 0, c: 0 }, e: { r: 0, c: 5 } },
          { s: { r: 6 + n, c: 0 }, e: { r: 6 + n, c: 5 } },
        ];
        ws["!rows"] = [];
        ws["!rows"][0] = { hpx: 32 };
        ws["!rows"][6 + n] = { hpx: 32 };

        // ── Style helper ──
        function sc(r, c, s) {
          const addr = XLSX.utils.encode_cell({ r, c });
          if (!ws[addr]) ws[addr] = { v: "", t: "s" };
          ws[addr].s = s;
        }

        // Title row 0
        for (let c = 0; c < 6; c++) sc(0, c, S.title);
        // Profile headers row 2
        for (let c = 0; c < 6; c++) sc(2, c, S.head);
        // Profile data rows
        for (let i = 0; i < n; i++) {
          const r = 3 + i,
            alt = i % 2 === 1;
          sc(r, 0, alt ? S.al : S.l);
          sc(r, 1, alt ? S.ac : S.c);
          sc(r, 2, alt ? S.al : S.l);
          sc(r, 3, alt ? S.ar : S.r);
          sc(r, 4, alt ? S.ar : S.r);
          sc(r, 5, alt ? S.ar : S.r);
        }
        // Profile total row
        for (let c = 0; c < 5; c++) sc(3 + n, c, S.tl);
        sc(3 + n, 5, S.tr);

        // Classification title
        for (let c = 0; c < 6; c++) sc(6 + n, c, S.title);
        // Classification headers
        for (let c = 0; c < 3; c++) sc(8 + n, c, S.head);
        // Classification data (4 categories)
        for (let i = 0; i < 4; i++) {
          const r = 9 + n + i,
            alt = i % 2 === 1;
          sc(r, 0, alt ? S.al : S.l);
          sc(r, 1, alt ? S.ac : S.c);
          sc(r, 2, alt ? S.ar : S.r);
        }
        // Connections row
        sc(13 + n, 0, S.al);
        sc(13 + n, 1, S.ac);
        sc(13 + n, 2, S.ar);
        // Total acero
        sc(15 + n, 0, S.tl);
        sc(15 + n, 1, S.tc);
        sc(15 + n, 2, S.tr);
        // Ton row
        sc(16 + n, 0, S.tl);
        sc(16 + n, 1, S.tc);
        sc(16 + n, 2, S.tr);

        // ── Download ──
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "Catálogo ICHA");
        XLSX.writeFile(
          wb,
          `Catalogo_ICHA_${new Date().toISOString().slice(0, 10)}.xlsx`,
        );
      }

      // ==================== KEYBOARD NAVIGATION ====================
      document
        .getElementById("profile-search")
        .addEventListener("input", function () {
          showSearchResults(this.value);
        });

      document
        .getElementById("profile-search")
        .addEventListener("focus", function () {
          if (currentSeries) showSearchResults(this.value);
        });

      document
        .getElementById("profile-search")
        .addEventListener("keydown", function (e) {
          const container = document.getElementById("search-results");
          const items = container.querySelectorAll(".dropdown-item");
          if (!items.length) return;

          if (e.key === "ArrowDown") {
            e.preventDefault();
            highlightedIndex = Math.min(highlightedIndex + 1, items.length - 1);
            updateHighlight(items);
          } else if (e.key === "ArrowUp") {
            e.preventDefault();
            highlightedIndex = Math.max(highlightedIndex - 1, 0);
            updateHighlight(items);
          } else if (e.key === "Enter" && highlightedIndex >= 0) {
            e.preventDefault();
            items[highlightedIndex].click();
          }
        });

      function updateHighlight(items) {
        items.forEach((item, i) => {
          item.classList.toggle("highlighted", i === highlightedIndex);
          if (i === highlightedIndex) item.scrollIntoView({ block: "nearest" });
        });
      }

      // Close dropdown when clicking outside
      document.addEventListener("click", function (e) {
        const searchPanel = document.getElementById("search-panel");
        if (!searchPanel.contains(e.target)) {
          document.getElementById("search-results").classList.add("hidden");
        }
      });

      // ==================== EVENT LISTENERS ====================
      document
        .getElementById("btn-add-list")
        .addEventListener("click", addToList);
      document
        .getElementById("btn-clear-list")
        .addEventListener("click", clearList);

      // Enter key to add
      ["list-mark", "list-len", "list-qty"].forEach((id) => {
        document.getElementById(id).addEventListener("keydown", (e) => {
          if (e.key === "Enter") addToList();
        });
      });

      // ==================== INIT ====================
      renderSeriesSelector();
    </script>
  </body>
</html>
