<!doctype html>
<html lang="es" class="scroll-smooth dark">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Herramientas BIM | Catálogo ICHA</title>
    <meta
      name="description"
      content="Catálogo de perfiles de acero ICHA con propiedades mecánicas. Selecciona perfiles, arma tu lista y exporta a Excel."
    />
    <link rel="icon" href="../assets/favicon.ico" sizes="any" />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap"
      rel="stylesheet"
    />
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx-js-style@1.2.0/dist/xlsx.bundle.js"></script>
    <script>
      tailwind.config = {
        darkMode: "class",
        theme: {
          extend: {
            colors: {
              "bim-blue": "#3b82f6",
              "bim-dark": "#0b1220",
              "bim-card": "#111827",
              "bim-border": "#1f2937",
            },
            fontFamily: { sans: ["Inter", "sans-serif"] },
          },
        },
      };
    </script>
    <style>
      .glass-card {
        background: rgba(17, 24, 39, 0.7);
        border: 1px solid rgba(55, 65, 81, 0.5);
        backdrop-filter: blur(12px);
      }
      .glass-nav {
        background: rgba(11, 18, 32, 0.85);
        backdrop-filter: blur(16px);
      }
      .profile-btn {
        transition: all 0.3s ease;
      }
      .profile-btn:hover,
      .profile-btn.active {
        border-color: #3b82f6;
        background: rgba(59, 130, 246, 0.1);
        transform: translateY(-2px);
        box-shadow: 0 4px 20px rgba(59, 130, 246, 0.2);
      }
      .profile-btn.active {
        background: rgba(59, 130, 246, 0.15);
        box-shadow: 0 0 20px rgba(59, 130, 246, 0.3);
      }
      .profile-btn.active .profile-icon {
        color: #3b82f6;
      }
      .result-value {
        background: linear-gradient(
          135deg,
          rgba(59, 130, 246, 0.1),
          rgba(59, 130, 246, 0.05)
        );
        border: 1px solid rgba(59, 130, 246, 0.3);
        transition: all 0.3s ease;
      }
      .result-value:hover {
        border-color: #3b82f6;
        box-shadow: 0 0 15px rgba(59, 130, 246, 0.15);
      }
      .input-field {
        background: rgba(17, 24, 39, 0.8);
        border: 1px solid rgba(55, 65, 81, 0.6);
        transition: all 0.2s ease;
      }
      .input-field:focus {
        border-color: #3b82f6;
        box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.15);
        outline: none;
      }
      .fade-in {
        animation: fadeIn 0.4s ease-out;
      }
      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: translateY(10px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }
      .search-dropdown {
        max-height: 280px;
        overflow-y: auto;
        scrollbar-width: thin;
        scrollbar-color: #3b82f6 transparent;
      }
      .search-dropdown::-webkit-scrollbar {
        width: 6px;
      }
      .search-dropdown::-webkit-scrollbar-track {
        background: transparent;
      }
      .search-dropdown::-webkit-scrollbar-thumb {
        background: #3b82f6;
        border-radius: 3px;
      }
      .dropdown-item {
        transition: all 0.15s ease;
      }
      .dropdown-item:hover,
      .dropdown-item.highlighted {
        background: rgba(59, 130, 246, 0.15);
        color: #3b82f6;
      }
      .prop-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
        gap: 0.75rem;
      }
      .prop-card {
        background: rgba(17, 24, 39, 0.6);
        border: 1px solid rgba(55, 65, 81, 0.4);
        border-radius: 0.75rem;
        padding: 0.75rem 1rem;
        transition: all 0.2s ease;
      }
      .prop-card:hover {
        border-color: rgba(59, 130, 246, 0.4);
        background: rgba(59, 130, 246, 0.05);
      }
    </style>
  </head>
  <body
    class="bg-gray-50 dark:bg-bim-dark text-gray-900 dark:text-gray-300 font-sans antialiased selection:bg-blue-500 selection:text-white"
  >
    <!-- Navigation -->
    <nav
      class="fixed w-full z-50 glass-nav border-b border-gray-200 dark:border-gray-800"
    >
      <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <div class="flex items-center justify-between h-16">
          <a href="../index.html" class="flex-shrink-0 flex items-center group">
            <i
              class="fa-solid fa-arrow-left text-gray-400 group-hover:text-bim-blue mr-3 transition-colors"
            ></i>
            <i class="fa-solid fa-layer-group text-bim-blue text-2xl mr-2"></i>
            <span class="font-bold text-xl text-gray-900 dark:text-white"
              >Andrés Gallo P<span class="text-bim-blue">.BIM</span></span
            >
          </a>
          <div class="hidden md:flex items-center space-x-2">
            <span class="text-gray-500 text-sm"
              ><i class="fa-solid fa-toolbox mr-1"></i> Tools</span
            >
            <span class="text-gray-600">›</span>
            <span class="text-bim-blue text-sm font-semibold"
              >Catálogo ICHA</span
            >
          </div>
        </div>
      </div>
    </nav>

    <!-- Hero Section -->
    <section class="pt-24 pb-8 relative overflow-hidden">
      <div
        class="absolute top-0 left-0 w-full h-full overflow-hidden -z-10 opacity-10"
      >
        <svg width="100%" height="100%" xmlns="http://www.w3.org/2000/svg">
          <defs>
            <pattern
              id="grid"
              width="40"
              height="40"
              patternUnits="userSpaceOnUse"
            >
              <path
                d="M 40 0 L 0 0 0 40"
                fill="none"
                stroke="#3b82f6"
                stroke-width="0.5"
              />
            </pattern>
          </defs>
          <rect width="100%" height="100%" fill="url(#grid)" />
        </svg>
      </div>
      <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <div class="text-center mb-8">
          <div
            class="inline-block mb-4 px-3 py-1 rounded-full bg-blue-900/30 border border-blue-800 text-bim-blue text-sm font-semibold tracking-wide"
          >
            <i class="fa-solid fa-database mr-1"></i> CATÁLOGO ICHA — NORMA
            CHILENA
          </div>
          <h1
            class="text-3xl md:text-5xl font-extrabold text-white tracking-tight mb-4"
          >
            Catálogo de <span class="text-bim-blue">Perfiles ICHA</span>
          </h1>
          <p class="max-w-2xl mx-auto text-gray-400 text-lg">
            Selecciona perfiles del catálogo ICHA con todas sus propiedades
            mecánicas precargadas. Arma tu lista de materiales y exporta a
            Excel.
          </p>
        </div>
      </div>
    </section>

    <!-- Profile Type Selector -->
    <section class="pb-6">
      <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <h2
          class="text-sm font-bold text-gray-500 uppercase tracking-wider mb-4"
        >
          <i class="fa-solid fa-shapes mr-2"></i>Selecciona la serie
        </h2>
        <div
          class="grid grid-cols-3 sm:grid-cols-4 md:grid-cols-7 lg:grid-cols-13 gap-2"
          id="series-selector"
        >
          <!-- Populated by JS -->
        </div>
      </div>
    </section>

    <!-- Main Calculator Section -->
    <section class="py-6">
      <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <div class="grid grid-cols-1 lg:grid-cols-[1fr_1.5fr] gap-6">
          <!-- Left: Search & Select -->
          <div class="glass-card rounded-xl p-6" id="search-panel">
            <h3
              class="text-sm font-bold text-gray-500 uppercase tracking-wider mb-4"
            >
              <i class="fa-solid fa-magnifying-glass mr-2"></i>Buscar Perfil
            </h3>
            <div class="relative mb-4">
              <input
                type="text"
                id="profile-search"
                placeholder="Escribe para buscar... (ej: IN 20)"
                class="input-field w-full px-4 py-3 pr-10 rounded-lg text-white text-sm"
                autocomplete="off"
              />
              <i
                class="fa-solid fa-search absolute right-3 top-3.5 text-gray-500 text-sm"
              ></i>
            </div>
            <div
              id="search-results"
              class="search-dropdown rounded-lg border border-gray-700/50 hidden"
            >
              <!-- Populated by JS -->
            </div>

            <!-- Selected Profile Display -->
            <div id="selected-profile-display" class="mt-4 hidden fade-in">
              <div class="result-value rounded-xl p-5 text-center">
                <div
                  class="text-xs text-gray-500 uppercase tracking-wider mb-1"
                >
                  Perfil Seleccionado
                </div>
                <span
                  class="text-2xl font-extrabold text-white"
                  id="selected-profile-name"
                  >—</span
                >
                <div class="mt-2 flex items-center justify-center gap-4">
                  <span class="text-sm text-gray-400"
                    >Peso:
                    <span class="text-bim-blue font-bold" id="selected-weight"
                      >—</span
                    >
                    kg/m</span
                  >
                  <span class="text-sm text-gray-400"
                    >Área:
                    <span class="text-white font-bold" id="selected-area"
                      >—</span
                    >
                    cm²</span
                  >
                </div>
              </div>
            </div>

            <!-- Add to List Controls -->
            <div
              class="mt-6 pt-4 border-t border-gray-700/50"
              id="add-controls"
              style="display: none"
            >
              <label class="text-xs font-semibold text-gray-400 mb-2 block"
                >Agregar a la Lista</label
              >
              <div class="flex flex-wrap gap-2 items-stretch">
                <!-- Marca -->
                <div class="relative flex-[2] min-w-[80px]">
                  <input
                    type="text"
                    id="list-mark"
                    placeholder="Marca"
                    class="input-field w-full px-3 py-2.5 rounded-lg text-white text-sm text-center"
                  />
                  <span class="absolute right-2 top-3 text-[10px] text-gray-500"
                    ><i class="fa-solid fa-tag"></i>
                  </span>
                </div>
                <!-- Largo -->
                <div class="relative flex-none w-[80px]">
                  <input
                    type="number"
                    id="list-len"
                    value="6"
                    min="0.1"
                    step="0.1"
                    class="input-field w-full px-3 pr-7 py-2.5 rounded-lg text-white font-bold text-center text-sm"
                  />
                  <span
                    class="absolute right-2 top-3 text-[10px] text-gray-500 font-medium"
                    >m</span
                  >
                </div>
                <!-- Cantidad -->
                <div class="relative flex-none w-[80px]">
                  <input
                    type="number"
                    id="list-qty"
                    value="1"
                    min="1"
                    class="input-field w-full px-3 pr-7 py-2.5 rounded-lg text-white font-bold text-center text-sm"
                  />
                  <span
                    class="absolute right-2 top-3 text-[10px] text-gray-500 font-medium"
                    >un.</span
                  >
                </div>
                <!-- Button -->
                <button
                  id="btn-add-list"
                  class="bg-bim-blue hover:bg-blue-600 text-white font-bold py-2.5 px-5 rounded-lg transition-colors flex items-center justify-center gap-2 group text-sm whitespace-nowrap"
                >
                  <i
                    class="fa-solid fa-plus group-hover:rotate-90 transition-transform text-sm"
                  ></i>
                  <span>+ Agregar</span>
                </button>
              </div>
            </div>
          </div>

          <!-- Right: Properties -->
          <div class="glass-card rounded-xl p-6" id="properties-panel">
            <h3
              class="text-sm font-bold text-gray-500 uppercase tracking-wider mb-4"
            >
              <i class="fa-solid fa-table-list mr-2"></i>Propiedades Mecánicas
            </h3>
            <div id="properties-grid" class="prop-grid">
              <div
                class="prop-card col-span-full text-center py-12 text-gray-600"
              >
                <i class="fa-solid fa-arrow-left text-3xl mb-3 block"></i>
                <p class="text-sm">
                  Selecciona una serie y luego un perfil para ver sus
                  propiedades
                </p>
              </div>
            </div>
          </div>
        </div>

        <!-- Profile List Summary Section -->
        <div class="mt-8 hidden" id="summary-section">
          <div class="glass-card rounded-xl p-6 overflow-hidden mb-6">
            <div class="flex items-center justify-between mb-4">
              <h3
                class="text-sm font-bold text-gray-500 uppercase tracking-wider"
              >
                <i class="fa-solid fa-list-check mr-2"></i>Resumen de Perfiles
                Seleccionados
              </h3>
              <div class="flex items-center gap-3">
                <button
                  onclick="exportToExcel()"
                  class="text-xs bg-green-600 hover:bg-green-500 text-white px-3 py-1.5 rounded-lg transition-all hover:-translate-y-0.5 shadow-lg shadow-green-900/30 flex items-center gap-1.5 font-bold"
                >
                  <i class="fa-solid fa-file-excel"></i> Exportar Excel
                </button>
                <button
                  id="btn-clear-list"
                  class="text-xs text-red-400 hover:text-red-300 transition-colors flex items-center gap-1"
                >
                  <i class="fa-solid fa-trash-can"></i> Limpiar Todo
                </button>
              </div>
            </div>

            <div class="overflow-x-auto">
              <table class="w-full text-left border-collapse">
                <thead>
                  <tr
                    class="border-b border-gray-700 text-xs text-gray-400 uppercase tracking-wider"
                  >
                    <th class="py-3 px-4 font-semibold text-left">Marca</th>
                    <th class="py-3 px-4 font-semibold text-center w-16">
                      Cant.
                    </th>
                    <th class="py-3 px-4 font-semibold">Perfil</th>
                    <th class="py-3 px-4 font-semibold text-right">
                      Largo <span class="text-gray-600 normal-case">(m)</span>
                    </th>
                    <th class="py-3 px-4 font-semibold text-right">
                      Peso Unit.
                      <span class="text-gray-600 normal-case">(kg/m)</span>
                    </th>
                    <th class="py-3 px-4 font-semibold text-right">
                      Peso Total
                      <span class="text-gray-600 normal-case">(kg)</span>
                    </th>
                    <th class="py-3 px-4 font-semibold text-center w-16"></th>
                  </tr>
                </thead>
                <tbody
                  id="profile-list-body"
                  class="text-sm text-gray-300 divide-y divide-gray-800"
                >
                  <!-- Populated by JS -->
                </tbody>
                <tfoot class="bg-gray-800/30">
                  <tr class="font-bold text-white border-t border-gray-600">
                    <td class="py-4 px-4" colspan="4">TOTALES:</td>
                    <td
                      class="py-4 px-4 text-right transform translate-x-3 text-gray-500"
                    >
                      —
                    </td>
                    <td
                      class="py-4 px-4 text-right text-bim-blue text-lg"
                      id="grand-total-weight"
                    >
                      0.00
                      <span class="text-xs text-gray-500 font-medium ml-1"
                        >kg</span
                      >
                    </td>
                    <td></td>
                  </tr>
                </tfoot>
              </table>
            </div>
          </div>
        </div>

        <!-- Classification by Nominal Weight -->
        <div class="mt-6 hidden" id="classification-section">
          <div class="glass-card rounded-xl p-6 overflow-hidden mb-6">
            <h3
              class="text-sm font-bold text-gray-500 uppercase tracking-wider mb-4"
            >
              <i class="fa-solid fa-weight-hanging mr-2"></i>Clasificación por
              Nominal Weight
            </h3>
            <div class="overflow-x-auto">
              <table class="w-full text-left border-collapse">
                <thead>
                  <tr
                    class="border-b border-gray-700 text-xs text-gray-400 uppercase tracking-wider"
                  >
                    <th class="py-3 px-4 font-semibold text-left">
                      Descripción
                    </th>
                    <th class="py-3 px-4 font-semibold text-right w-24">
                      Unidad
                    </th>
                    <th class="py-3 px-4 font-semibold text-right w-32">
                      Cantidad
                    </th>
                  </tr>
                </thead>
                <tbody id="classification-body" class="text-sm text-gray-300">
                  <!-- Populated by JS -->
                </tbody>
              </table>
            </div>
            <div
              class="mt-4 pt-3 border-t border-gray-600 flex items-center justify-between"
            >
              <span class="text-sm font-bold text-white"
                >Total Acero (con conexiones):</span
              >
              <span
                class="text-lg font-extrabold text-bim-blue"
                id="classification-total"
                >0.00 <span class="text-xs text-gray-500">kg</span></span
              >
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- Footer -->
    <footer class="py-8 border-t border-gray-800 mt-12">
      <div class="max-w-7xl mx-auto px-4 text-center">
        <p class="text-gray-500 text-sm">
          &copy; 2026 Andrés Gallo P. — Herramientas para Proyectistas
          Estructurales
        </p>
      </div>
    </footer>

    <script src="icha_data.js"></script>
    <script>
      // ==================== STATE ====================
      let currentSeries = null;
      let selectedProfile = null;
      const profileList = [];
      let highlightedIndex = -1;

      // ==================== PROPERTY LABELS ====================
      const PROP_LABELS = {
        weight: {
          label: "Peso Lineal",
          unit: "kg/m",
          icon: "fa-weight-hanging",
        },
        A_cm2: { label: "Área Sección", unit: "cm²", icon: "fa-vector-square" },
        B_mm: { label: "Ancho (B)", unit: "mm", icon: "fa-arrows-left-right" },
        e_mm: { label: "Espesor (e)", unit: "mm", icon: "fa-ruler" },
        t_mm: { label: "Espesor ala (t)", unit: "mm", icon: "fa-ruler" },
        C_mm: { label: "Labio (C)", unit: "mm", icon: "fa-ruler" },
        Ix_cm4: { label: "Ix", unit: "cm⁴", icon: "fa-rotate" },
        Wx_cm3: { label: "Wx", unit: "cm³", icon: "fa-cube" },
        ix_cm: { label: "ix", unit: "cm", icon: "fa-circle-dot" },
        Iy_cm4: { label: "Iy", unit: "cm⁴", icon: "fa-rotate" },
        Wy_cm3: { label: "Wy", unit: "cm³", icon: "fa-cube" },
        iy_cm: { label: "iy", unit: "cm", icon: "fa-circle-dot" },
        xy_cm: { label: "x=y", unit: "cm", icon: "fa-crosshairs" },
        x_cm: { label: "x", unit: "cm", icon: "fa-crosshairs" },
        y_cm: { label: "y", unit: "cm", icon: "fa-crosshairs" },
        X_cm: { label: "X (cg)", unit: "cm", icon: "fa-crosshairs" },
        iu_cm: { label: "i (eje U)", unit: "cm", icon: "fa-circle-dot" },
        iv_cm: { label: "i (eje V)", unit: "cm", icon: "fa-circle-dot" },
      };

      // ==================== SERIES SELECTOR ====================
      function renderSeriesSelector() {
        const container = document.getElementById("series-selector");
        container.innerHTML = "";
        for (const [key, series] of Object.entries(ICHA_CATALOG)) {
          const btn = document.createElement("button");
          btn.className =
            "profile-btn glass-card rounded-xl p-3 flex flex-col items-center justify-center gap-1 cursor-pointer border border-transparent";
          btn.innerHTML = `
            <i class="${series.icon} profile-icon text-gray-400 text-lg"></i>
            <span class="text-xs font-bold text-gray-400 leading-tight text-center">${key.replace("_desig", "")}</span>
            <span class="text-[10px] text-gray-600 leading-tight text-center truncate w-full">${series.name.split("(")[0].trim()}</span>
          `;
          btn.addEventListener("click", () => selectSeries(key));
          container.appendChild(btn);
        }
      }

      function selectSeries(key) {
        currentSeries = key;
        selectedProfile = null;
        highlightedIndex = -1;

        // Update buttons
        document
          .querySelectorAll("#series-selector .profile-btn")
          .forEach((btn, i) => {
            const seriesKey = Object.keys(ICHA_CATALOG)[i];
            btn.classList.toggle("active", seriesKey === key);
          });

        // Reset search
        const searchInput = document.getElementById("profile-search");
        searchInput.value = "";
        searchInput.placeholder = `Buscar en ${ICHA_CATALOG[key].name}...`;
        searchInput.focus();

        // Show all profiles for this series
        showSearchResults("");

        // Hide selected profile
        document
          .getElementById("selected-profile-display")
          .classList.add("hidden");
        document.getElementById("add-controls").style.display = "none";

        // Reset properties
        document.getElementById("properties-grid").innerHTML = `
          <div class="prop-card col-span-full text-center py-8 text-gray-600">
            <i class="fa-solid fa-search text-2xl mb-2 block"></i>
            <p class="text-sm">${ICHA_CATALOG[key].profiles.length} perfiles disponibles — busca o selecciona uno</p>
          </div>
        `;
      }

      // ==================== SEARCH ====================
      function showSearchResults(query) {
        if (!currentSeries) return;
        const container = document.getElementById("search-results");
        const profiles = ICHA_CATALOG[currentSeries].profiles;
        const q = query.toLowerCase().replace(/\s+/g, "");

        const filtered = profiles.filter((p) => {
          const desig = p.designation.toLowerCase().replace(/\s+/g, "");
          return desig.includes(q);
        });

        if (filtered.length === 0) {
          container.innerHTML = `<div class="p-4 text-center text-gray-500 text-sm">No se encontraron perfiles</div>`;
          container.classList.remove("hidden");
          return;
        }

        container.innerHTML = filtered
          .map(
            (p, i) => `
          <div class="dropdown-item px-4 py-2.5 cursor-pointer text-sm flex items-center justify-between border-b border-gray-800/50 last:border-0"
               data-index="${profiles.indexOf(p)}" data-filtered-index="${i}">
            <span class="font-semibold text-white">${p.designation}</span>
            <span class="text-xs text-gray-500">${p.weight} kg/m</span>
          </div>`,
          )
          .join("");

        container.classList.remove("hidden");
        highlightedIndex = -1;

        // Add click handlers
        container.querySelectorAll(".dropdown-item").forEach((item) => {
          item.addEventListener("click", () => {
            const idx = parseInt(item.dataset.index);
            selectProfile(profiles[idx]);
            container.classList.add("hidden");
          });
        });
      }

      // ==================== SELECT PROFILE ====================
      function selectProfile(profile) {
        selectedProfile = profile;
        const searchInput = document.getElementById("profile-search");
        searchInput.value = profile.designation;

        // Show selected profile
        document
          .getElementById("selected-profile-display")
          .classList.remove("hidden");
        document.getElementById("selected-profile-name").textContent =
          profile.designation;
        document.getElementById("selected-weight").textContent =
          profile.weight.toFixed(1);
        document.getElementById("selected-area").textContent = (
          profile.A_cm2 || 0
        ).toFixed(1);

        // Show add controls
        document.getElementById("add-controls").style.display = "block";

        // Render properties
        renderProperties(profile);
      }

      function renderProperties(profile) {
        const grid = document.getElementById("properties-grid");
        let html = "";

        // Priority order for properties
        const order = [
          "weight",
          "A_cm2",
          "B_mm",
          "e_mm",
          "t_mm",
          "C_mm",
          "Ix_cm4",
          "Wx_cm3",
          "ix_cm",
          "Iy_cm4",
          "Wy_cm3",
          "iy_cm",
          "xy_cm",
          "x_cm",
          "y_cm",
          "X_cm",
          "iu_cm",
          "iv_cm",
        ];

        for (const key of order) {
          if (profile[key] === undefined || profile[key] === null) continue;
          const meta = PROP_LABELS[key];
          if (!meta) continue;

          const isWeight = key === "weight";
          html += `
            <div class="prop-card ${isWeight ? "border-blue-500/30 bg-blue-500/5" : ""}">
              <div class="flex items-center gap-2 mb-1">
                <i class="fa-solid ${meta.icon} text-[10px] ${isWeight ? "text-bim-blue" : "text-gray-600"}"></i>
                <span class="text-xs text-gray-500 font-medium">${meta.label}</span>
              </div>
              <div class="flex items-baseline gap-1">
                <span class="text-lg font-extrabold ${isWeight ? "text-bim-blue" : "text-white"}">${formatNumber(profile[key])}</span>
                <span class="text-[10px] text-gray-500">${meta.unit}</span>
              </div>
            </div>
          `;
        }

        grid.innerHTML =
          html ||
          `<div class="col-span-full text-center py-8 text-gray-500">Sin propiedades disponibles</div>`;
      }

      function formatNumber(n) {
        if (n === null || n === undefined) return "—";
        if (Math.abs(n) >= 10000) return n.toLocaleString("es-CL");
        if (Number.isInteger(n)) return n.toString();
        return n.toFixed(n < 10 ? 2 : 1);
      }

      // ==================== PROFILE LIST ====================
      function addToList() {
        if (!selectedProfile) return;
        const mark = document.getElementById("list-mark").value || "—";
        const len = parseFloat(document.getElementById("list-len").value) || 6;
        const qty = parseInt(document.getElementById("list-qty").value) || 1;

        profileList.push({
          mark,
          qty,
          designation: selectedProfile.designation,
          length: len,
          unitWeight: selectedProfile.weight,
          totalWeight: qty * len * selectedProfile.weight,
        });

        renderProfileList();
        document.getElementById("list-mark").value = "";
      }

      function removeFromList(index) {
        profileList.splice(index, 1);
        renderProfileList();
      }

      function clearList() {
        profileList.length = 0;
        renderProfileList();
      }

      function renderProfileList() {
        const tbody = document.getElementById("profile-list-body");
        const section = document.getElementById("summary-section");
        const classSection = document.getElementById("classification-section");

        if (profileList.length === 0) {
          section.classList.add("hidden");
          classSection.classList.add("hidden");
          return;
        }
        section.classList.remove("hidden");
        classSection.classList.remove("hidden");

        let totalWeight = 0;
        tbody.innerHTML = profileList
          .map((item, i) => {
            totalWeight += item.totalWeight;
            const bgClass = i % 2 === 0 ? "" : "bg-gray-800/20";
            return `
              <tr class="${bgClass} hover:bg-gray-700/30 transition-colors">
                <td class="py-3 px-4 font-semibold text-white">${item.mark}</td>
                <td class="py-3 px-4 text-center font-bold">${item.qty}</td>
                <td class="py-3 px-4 text-bim-blue font-semibold">${item.designation}</td>
                <td class="py-3 px-4 text-right">${item.length.toFixed(1)}</td>
                <td class="py-3 px-4 text-right">${item.unitWeight.toFixed(2)}</td>
                <td class="py-3 px-4 text-right font-bold text-white">${item.totalWeight.toFixed(2)}</td>
                <td class="py-3 px-4 text-center">
                  <button onclick="removeFromList(${i})" class="text-red-500 hover:text-red-400 transition-colors">
                    <i class="fa-solid fa-xmark"></i>
                  </button>
                </td>
              </tr>`;
          })
          .join("");

        document.getElementById("grand-total-weight").innerHTML =
          `${totalWeight.toFixed(2)} <span class="text-xs text-gray-500 font-medium ml-1">kg</span>`;

        updateClassification();
      }

      // ==================== CLASSIFICATION ====================
      function updateClassification() {
        const categories = [
          { name: "Perfiles Livianos (< 25 kg/m)", min: 0, max: 25 },
          { name: "Perfiles Medios (25 – 50 kg/m)", min: 25, max: 50 },
          { name: "Perfiles Pesados (50 – 100 kg/m)", min: 50, max: 100 },
          {
            name: "Perfiles Extra Pesados (≥ 100 kg/m)",
            min: 100,
            max: Infinity,
          },
        ];

        const catWeights = categories.map(() => 0);
        profileList.forEach((item) => {
          for (let i = 0; i < categories.length; i++) {
            if (
              item.unitWeight >= categories[i].min &&
              item.unitWeight < categories[i].max
            ) {
              catWeights[i] += item.totalWeight;
              break;
            }
          }
        });

        const tbody = document.getElementById("classification-body");
        const totalWeight = catWeights.reduce((a, b) => a + b, 0);
        const connection = totalWeight * 0.1;
        const grandTotal = totalWeight + connection;

        tbody.innerHTML =
          categories
            .map((cat, i) => {
              const bgClass = i % 2 === 0 ? "" : "bg-gray-800/20";
              return `
              <tr class="${bgClass} border-b border-gray-800">
                <td class="py-3 px-4">${cat.name}</td>
                <td class="py-3 px-4 text-right text-gray-500">kg</td>
                <td class="py-3 px-4 text-right font-bold text-white">${catWeights[i].toFixed(2)}</td>
              </tr>`;
            })
            .join("") +
          `<tr class="border-b border-gray-800 bg-gray-800/20">
            <td class="py-3 px-4 font-semibold text-yellow-400">+ 10% Conexiones</td>
            <td class="py-3 px-4 text-right text-gray-500">kg</td>
            <td class="py-3 px-4 text-right font-bold text-yellow-400">${connection.toFixed(2)}</td>
          </tr>`;

        document.getElementById("classification-total").innerHTML =
          `${grandTotal.toFixed(2)} <span class="text-xs text-gray-500">kg</span>`;
      }

      // ==================== EXCEL EXPORT ====================
      function exportToExcel() {
        if (profileList.length === 0) return;

        const wb = XLSX.utils.book_new();
        const data = [];

        // Title
        data.push(["CATÁLOGO ICHA — RESUMEN DE PERFILES"]);
        data.push([`Fecha: ${new Date().toLocaleDateString("es-CL")}`]);
        data.push([]);

        // Profile list header
        data.push(["LISTADO DE PERFILES"]);
        data.push([
          "Marca",
          "Cant.",
          "Perfil",
          "Largo (m)",
          "Peso Unit. (kg/m)",
          "Peso Total (kg)",
        ]);

        let totalWeight = 0;
        profileList.forEach((item) => {
          totalWeight += item.totalWeight;
          data.push([
            item.mark,
            item.qty,
            item.designation,
            item.length,
            item.unitWeight,
            item.totalWeight,
          ]);
        });

        data.push(["", "", "", "", "TOTAL:", totalWeight]);
        data.push([]);

        // Classification
        data.push(["CLASIFICACIÓN POR NOMINAL WEIGHT"]);
        data.push(["Descripción", "Unidad", "Cantidad"]);

        const categories = [
          { name: "Perfiles Livianos (< 25 kg/m)", min: 0, max: 25 },
          { name: "Perfiles Medios (25 – 50 kg/m)", min: 25, max: 50 },
          { name: "Perfiles Pesados (50 – 100 kg/m)", min: 50, max: 100 },
          {
            name: "Perfiles Extra Pesados (≥ 100 kg/m)",
            min: 100,
            max: Infinity,
          },
        ];

        const catWeights = categories.map(() => 0);
        profileList.forEach((item) => {
          for (let i = 0; i < categories.length; i++) {
            if (
              item.unitWeight >= categories[i].min &&
              item.unitWeight < categories[i].max
            ) {
              catWeights[i] += item.totalWeight;
              break;
            }
          }
        });

        categories.forEach((cat, i) => {
          data.push([cat.name, "kg", catWeights[i]]);
        });

        const connection = totalWeight * 0.1;
        data.push(["+ 10% Conexiones", "kg", connection]);
        data.push(["TOTAL ACERO", "kg", totalWeight + connection]);

        const ws = XLSX.utils.aoa_to_sheet(data);

        // Column widths
        ws["!cols"] = [
          { wch: 35 },
          { wch: 8 },
          { wch: 25 },
          { wch: 12 },
          { wch: 18 },
          { wch: 18 },
        ];

        // Styling
        const titleStyle = {
          font: { bold: true, sz: 14, color: { rgb: "1F4E79" } },
          alignment: { horizontal: "left" },
        };
        const headerStyle = {
          font: { bold: true, sz: 10, color: { rgb: "FFFFFF" } },
          fill: { fgColor: { rgb: "2E75B6" } },
          alignment: { horizontal: "center" },
          border: {
            top: { style: "thin", color: { rgb: "1F4E79" } },
            bottom: { style: "thin", color: { rgb: "1F4E79" } },
          },
        };
        const totalStyle = {
          font: { bold: true, sz: 11, color: { rgb: "1F4E79" } },
          fill: { fgColor: { rgb: "D6E4F0" } },
          border: {
            top: { style: "medium", color: { rgb: "1F4E79" } },
            bottom: { style: "medium", color: { rgb: "1F4E79" } },
          },
        };
        const dataStyleEven = {
          font: { sz: 10 },
          fill: { fgColor: { rgb: "F2F7FB" } },
          border: {
            bottom: { style: "thin", color: { rgb: "D6E4F0" } },
          },
        };
        const dataStyleOdd = {
          font: { sz: 10 },
          fill: { fgColor: { rgb: "FFFFFF" } },
          border: {
            bottom: { style: "thin", color: { rgb: "D6E4F0" } },
          },
        };

        // Apply title styles
        if (ws["A1"]) ws["A1"].s = titleStyle;
        if (ws["A2"])
          ws["A2"].s = { font: { sz: 9, color: { rgb: "808080" } } };
        if (ws["A4"])
          ws["A4"].s = {
            font: { bold: true, sz: 12, color: { rgb: "1F4E79" } },
          };

        // Apply header styles (row 5 = index 4)
        const cols = ["A", "B", "C", "D", "E", "F"];
        cols.forEach((c) => {
          const cell = ws[`${c}5`];
          if (cell) cell.s = headerStyle;
        });

        // Apply data styles
        for (let i = 0; i < profileList.length; i++) {
          const row = 6 + i;
          cols.forEach((c) => {
            const cell = ws[`${c}${row}`];
            if (cell) cell.s = i % 2 === 0 ? dataStyleEven : dataStyleOdd;
          });
        }

        // Apply total row style
        const totalRow = 6 + profileList.length;
        cols.forEach((c) => {
          const cell = ws[`${c}${totalRow}`];
          if (cell) cell.s = totalStyle;
        });

        // Classification section styles
        const classHeaderRow = totalRow + 2;
        if (ws[`A${classHeaderRow}`])
          ws[`A${classHeaderRow}`].s = {
            font: { bold: true, sz: 12, color: { rgb: "1F4E79" } },
          };
        const classColHeaderRow = classHeaderRow + 1;
        ["A", "B", "C"].forEach((c) => {
          const cell = ws[`${c}${classColHeaderRow}`];
          if (cell) cell.s = headerStyle;
        });

        XLSX.utils.book_append_sheet(wb, ws, "Catálogo ICHA");
        XLSX.writeFile(
          wb,
          `Catalogo_ICHA_${new Date().toISOString().slice(0, 10)}.xlsx`,
        );
      }

      // ==================== KEYBOARD NAVIGATION ====================
      document
        .getElementById("profile-search")
        .addEventListener("input", function () {
          showSearchResults(this.value);
        });

      document
        .getElementById("profile-search")
        .addEventListener("focus", function () {
          if (currentSeries) showSearchResults(this.value);
        });

      document
        .getElementById("profile-search")
        .addEventListener("keydown", function (e) {
          const container = document.getElementById("search-results");
          const items = container.querySelectorAll(".dropdown-item");
          if (!items.length) return;

          if (e.key === "ArrowDown") {
            e.preventDefault();
            highlightedIndex = Math.min(highlightedIndex + 1, items.length - 1);
            updateHighlight(items);
          } else if (e.key === "ArrowUp") {
            e.preventDefault();
            highlightedIndex = Math.max(highlightedIndex - 1, 0);
            updateHighlight(items);
          } else if (e.key === "Enter" && highlightedIndex >= 0) {
            e.preventDefault();
            items[highlightedIndex].click();
          }
        });

      function updateHighlight(items) {
        items.forEach((item, i) => {
          item.classList.toggle("highlighted", i === highlightedIndex);
          if (i === highlightedIndex) item.scrollIntoView({ block: "nearest" });
        });
      }

      // Close dropdown when clicking outside
      document.addEventListener("click", function (e) {
        const searchPanel = document.getElementById("search-panel");
        if (!searchPanel.contains(e.target)) {
          document.getElementById("search-results").classList.add("hidden");
        }
      });

      // ==================== EVENT LISTENERS ====================
      document
        .getElementById("btn-add-list")
        .addEventListener("click", addToList);
      document
        .getElementById("btn-clear-list")
        .addEventListener("click", clearList);

      // Enter key to add
      ["list-mark", "list-len", "list-qty"].forEach((id) => {
        document.getElementById(id).addEventListener("keydown", (e) => {
          if (e.key === "Enter") addToList();
        });
      });

      // ==================== INIT ====================
      renderSeriesSelector();
    </script>
  </body>
</html>
