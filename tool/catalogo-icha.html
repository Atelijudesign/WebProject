<!doctype html>
<html lang="es" class="scroll-smooth dark">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Catálogo ICHA Digital | Buscador de Perfiles de Acero</title>
    <meta
      name="description"
      content="Catálogo interactivo ICHA con propiedades mecánicas completas (Peso, Inercia, Radio de Giro). Busca, filtra y exporta listas de acero a Excel."
    />
    <meta
      name="keywords"
      content="catalogo ICHA, perfiles acero chile, propiedades mecanicas acero, ICHA digital, buscar perfiles, tabla perfiles acero"
    />

    <!-- Open Graph -->
    <meta
      property="og:title"
      content="Catálogo ICHA Digital | Buscador de Perfiles"
    />
    <meta
      property="og:description"
      content="Accede a todas las propiedades mecánicas de perfiles ICHA. Búsqueda inteligente y exportación a Excel."
    />
    <meta property="og:type" content="website" />
    <meta
      property="og:url"
      content="https://atelijudesign.com/tool/catalogo-icha.html"
    />
    <meta property="og:locale" content="es_CL" />

    <link rel="icon" href="../assets/favicon.ico" sizes="any" />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap"
      rel="stylesheet"
    />
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx-js-style@1.2.0/dist/xlsx.bundle.js"></script>
    <script>
      tailwind.config = {
        darkMode: "class",
        theme: {
          extend: {
            colors: {
              "bim-blue": "#3b82f6",
              "bim-dark": "#0b1220",
              "bim-card": "#111827",
              "bim-border": "#1f2937",
            },
            fontFamily: { sans: ["Inter", "sans-serif"] },
          },
        },
      };
    </script>
    <style>
      .glass-card {
        background: rgba(17, 24, 39, 0.7);
        border: 1px solid rgba(55, 65, 81, 0.5);
        backdrop-filter: blur(12px);
      }
      .glass-nav {
        background: rgba(11, 18, 32, 0.85);
        backdrop-filter: blur(16px);
      }
      .profile-btn {
        transition: all 0.3s ease;
      }
      .profile-btn:hover,
      .profile-btn.active {
        border-color: #3b82f6;
        background: rgba(59, 130, 246, 0.1);
        transform: translateY(-2px);
        box-shadow: 0 4px 20px rgba(59, 130, 246, 0.2);
      }
      .profile-btn.active {
        background: rgba(59, 130, 246, 0.15);
        box-shadow: 0 0 20px rgba(59, 130, 246, 0.3);
      }
      .profile-btn.active .profile-icon {
        color: #3b82f6;
      }
      .result-value {
        background: linear-gradient(
          135deg,
          rgba(59, 130, 246, 0.1),
          rgba(59, 130, 246, 0.05)
        );
        border: 1px solid rgba(59, 130, 246, 0.3);
        transition: all 0.3s ease;
      }
      .result-value:hover {
        border-color: #3b82f6;
        box-shadow: 0 0 15px rgba(59, 130, 246, 0.15);
      }
      .input-field {
        background: rgba(17, 24, 39, 0.8);
        border: 1px solid rgba(55, 65, 81, 0.6);
        transition: all 0.2s ease;
      }
      .input-field:focus {
        border-color: #3b82f6;
        box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.15);
        outline: none;
      }
      .fade-in {
        animation: fadeIn 0.4s ease-out;
      }
      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: translateY(10px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }
      .svg-diagram {
        filter: drop-shadow(0 0 8px rgba(59, 130, 246, 0.2));
      }
      .search-dropdown {
        max-height: 280px;
        overflow-y: auto;
        scrollbar-width: thin;
        scrollbar-color: #3b82f6 transparent;
      }
      .search-dropdown::-webkit-scrollbar {
        width: 6px;
      }
      .search-dropdown::-webkit-scrollbar-track {
        background: transparent;
      }
      .search-dropdown::-webkit-scrollbar-thumb {
        background: #3b82f6;
        border-radius: 3px;
      }
      .dropdown-item {
        transition: all 0.15s ease;
      }
      .dropdown-item:hover,
      .dropdown-item.highlighted {
        background: rgba(59, 130, 246, 0.15);
        color: #3b82f6;
      }
      .prop-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
        gap: 0.75rem;
      }
      .prop-card {
        background: rgba(17, 24, 39, 0.6);
        border: 1px solid rgba(55, 65, 81, 0.4);
        border-radius: 0.75rem;
        padding: 0.75rem 1rem;
        transition: all 0.2s ease;
      }
      .prop-card:hover {
        border-color: rgba(59, 130, 246, 0.4);
        background: rgba(59, 130, 246, 0.05);
      }
    </style>
  </head>
  <body
    class="bg-gray-50 dark:bg-bim-dark text-gray-900 dark:text-gray-300 font-sans antialiased selection:bg-blue-500 selection:text-white"
  >
    <!-- Navigation -->
    <nav
      class="fixed w-full z-50 glass-nav border-b border-gray-200 dark:border-gray-800"
    >
      <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <div class="flex items-center justify-between h-16">
          <a href="../index.html" class="flex items-center gap-3 group">
            <i
              class="fa-solid fa-cube text-2xl text-bim-blue group-hover:rotate-12 transition-transform"
            ></i>
            <span class="text-xl font-bold tracking-tight"
              >Andrés Gallo <span class="text-bim-blue">BIM</span></span
            >
          </a>
          <div class="hidden md:flex items-center gap-8">
            <a
              href="https://atelijudesign.com"
              class="text-sm font-medium hover:text-bim-blue transition-colors relative group"
            >
              <span data-i18n="nav_back_home">Inicio</span>
              <span
                class="absolute bottom-[-4px] left-0 w-0 h-0.5 bg-bim-blue transition-all group-hover:w-full"
              ></span>
            </a>
            <a
              href="https://atelijudesign.com/blog.html"
              class="text-sm font-medium hover:text-bim-blue transition-colors relative group"
            >
              <span data-i18n="nav_blog">BLOG</span>
              <span
                class="absolute bottom-[-4px] left-0 w-0 h-0.5 bg-bim-blue transition-all group-hover:w-full"
              ></span>
            </a>
            <a
              href="../index.html"
              class="text-sm font-medium hover:text-bim-blue transition-colors relative group"
            >
              <span data-i18n="nav_tools">Tools</span>
              <span
                class="absolute bottom-[-4px] left-0 w-0 h-0.5 bg-bim-blue transition-all group-hover:w-full"
              ></span>
            </a>
          </div>
        </div>
      </div>
    </nav>

    <!-- Hero Section -->
    <section class="pt-24 pb-8 relative overflow-hidden">
      <div
        class="absolute top-0 left-0 w-full h-full overflow-hidden -z-10 opacity-10"
      >
        <svg width="100%" height="100%" xmlns="http://www.w3.org/2000/svg">
          <defs>
            <pattern
              id="grid"
              width="40"
              height="40"
              patternUnits="userSpaceOnUse"
            >
              <path
                d="M 40 0 L 0 0 0 40"
                fill="none"
                stroke="#3b82f6"
                stroke-width="0.5"
              />
            </pattern>
          </defs>
          <rect width="100%" height="100%" fill="url(#grid)" />
        </svg>
      </div>
      <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <div class="container mx-auto px-4 relative z-10 text-center">
          <div
            class="inline-block px-3 py-1 rounded-full bg-blue-900/30 border border-blue-500/30 text-blue-400 text-xs font-bold mb-4 tracking-wider uppercase fade-in-up"
            data-i18n="cat_hero_tag"
          >
            CATÁLOGO ICHA — NORMA CHILENA
          </div>
          <h1
            class="text-4xl md:text-6xl font-black mb-6 leading-tight fade-in-up delay-100"
          >
            <span data-i18n="cat_hero_title_prefix">Catálogo de</span>
            <span class="text-gradient" data-i18n="cat_hero_title_suffix"
              >Perfiles ICHA</span
            >
          </h1>
          <p
            class="text-lg text-gray-400 max-w-2xl mx-auto mb-10 fade-in-up delay-200"
            data-i18n="cat_hero_desc"
          >
            Selecciona perfiles del catálogo ICHA con todas sus propiedades
            mecánicas precargadas. Arma tu lista de materiales y exporta a
            Excel.
          </p>
        </div>
      </div>
    </section>

    <!-- Profile Type Selector -->
    <section class="pb-6">
      <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <h2
          class="text-sm font-bold text-gray-500 uppercase tracking-wider mb-4"
          data-i18n="sect_select_series"
        >
          <i class="fa-solid fa-shapes mr-2"></i>Selecciona la serie
        </h2>
        <div
          class="grid grid-cols-3 sm:grid-cols-4 md:grid-cols-7 lg:grid-cols-13 gap-2"
          id="series-selector"
        >
          <!-- Populated by JS -->
        </div>
      </div>
    </section>

    <!-- Main Calculator Section -->
    <section class="py-6">
      <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <div class="grid grid-cols-1 lg:grid-cols-[1.1fr_0.7fr_1.2fr] gap-6">
          <!-- Left: SVG Diagram -->
          <!-- Diagrama SVG -->
          <!-- Diagrama SVG + 3D Viewer -->
          <div
            class="glass-card rounded-xl p-6 flex flex-col items-center relative min-h-[350px]"
          >
            <h3
              class="text-xs font-bold text-gray-500 uppercase tracking-wider mb-4 self-start"
              data-i18n="sect_cross_section"
            >
              Sección Transversal
            </h3>

            <!-- 2D Container -->
            <div
              id="svg-container"
              class="w-full max-w-[240px] aspect-square flex items-center justify-center transition-all duration-300"
            >
              <div class="text-center text-gray-600">
                <i class="fa-solid fa-shapes text-4xl mb-3 block"></i>
                <p class="text-sm" data-i18n="diagram_placeholder">
                  Selecciona un perfil
                </p>
              </div>
            </div>

            <div id="profile-designation" class="mt-4 text-center">
              <span
                class="text-2xl font-extrabold text-white"
                id="designation-text"
                >—</span
              >
            </div>
          </div>

          <!-- Center: Search & Select -->
          <div class="glass-card rounded-xl p-6" id="search-panel">
            <h3
              class="text-sm font-bold text-gray-500 uppercase tracking-wider mb-4"
              data-i18n="sect_search_profile"
            >
              <i class="fa-solid fa-magnifying-glass mr-2"></i>Buscar Perfil
            </h3>
            <div class="relative mb-4">
              <input
                type="text"
                id="profile-search"
                placeholder="Escribe para buscar... (ej: IN 20)"
                class="input-field w-full px-4 py-3 pr-10 rounded-lg text-white text-sm"
                autocomplete="off"
                data-i18n-placeholder="search_placeholder"
              />
              <i
                class="fa-solid fa-search absolute right-3 top-3.5 text-gray-500 text-sm"
              ></i>
            </div>
            <div
              id="search-results"
              class="search-dropdown rounded-lg border border-gray-700/50 hidden"
            >
              <!-- Populated by JS -->
            </div>

            <!-- Selected Profile Display -->
            <div id="selected-profile-display" class="hidden animate-fade-in">
              <div class="glass-card rounded-xl p-6 border-l-4 border-bim-blue">
                <div class="flex items-center justify-between mb-4">
                  <h3
                    class="text-2xl font-black text-white"
                    id="selected-profile-name"
                  >
                    —
                  </h3>
                  <div class="text-right">
                    <p
                      class="text-xs text-gray-500 uppercase font-bold"
                      data-i18n="res_weight"
                    >
                      Peso Lineal
                    </p>
                    <p class="text-lg font-bold text-bim-blue">
                      <span id="selected-weight">0.0</span> kg/m
                    </p>
                  </div>
                </div>
                <div class="flex items-center justify-between">
                  <div class="text-xs text-gray-500">
                    <span class="font-bold">ICHA</span> Standard
                  </div>
                  <div class="text-right">
                    <p
                      class="text-xs text-gray-500 uppercase font-bold"
                      data-i18n="res_area"
                    >
                      Área
                    </p>
                    <p class="text-sm font-bold text-white">
                      <span id="selected-area">0.0</span> cm²
                    </p>
                  </div>
                </div>
              </div>
            </div>

            <!-- Add to List Controls -->
            <div
              class="glass-card rounded-xl p-6 hidden animate-fade-in"
              id="add-controls"
            >
              <label
                class="block text-xs font-bold text-gray-500 uppercase tracking-wider mb-3"
                data-i18n="lbl_add_list"
                >Agregar a la Lista</label
              >
              <div class="flex flex-wrap gap-2 items-stretch">
                <!-- Marca -->
                <div class="relative flex-[2] min-w-[80px]">
                  <input
                    type="text"
                    id="list-mark"
                    placeholder="Marca"
                    class="input-field w-full px-3 py-2.5 rounded-lg text-white text-sm text-center"
                    data-i18n-placeholder="lbl_mark"
                  />
                  <span class="absolute right-2 top-3 text-[10px] text-gray-500"
                    ><i class="fa-solid fa-tag"></i>
                  </span>
                </div>
                <!-- Largo -->
                <div class="relative flex-none w-[80px]">
                  <input
                    type="number"
                    id="list-len"
                    value="6"
                    min="0.1"
                    step="0.1"
                    class="input-field w-full px-3 pr-7 py-2.5 rounded-lg text-white font-bold text-center text-sm"
                  />
                  <span
                    class="absolute right-2 top-3 text-[10px] text-gray-500 font-medium"
                    >m</span
                  >
                </div>
                <!-- Cantidad -->
                <div class="relative flex-none w-[80px]">
                  <input
                    type="number"
                    id="list-qty"
                    value="1"
                    min="1"
                    class="input-field w-full px-3 pr-7 py-2.5 rounded-lg text-white font-bold text-center text-sm"
                  />
                  <span
                    class="absolute right-2 top-3 text-[10px] text-gray-500 font-medium"
                    >un.</span
                  >
                </div>
                <!-- Button -->
                <button
                  id="btn-add-list"
                  class="bg-bim-blue hover:bg-blue-600 text-white font-bold py-2.5 px-5 rounded-lg transition-colors flex items-center justify-center gap-2 group text-sm whitespace-nowrap flex-[2]"
                  onclick="addToProfileList()"
                >
                  <i
                    class="fa-solid fa-plus group-hover:rotate-90 transition-transform text-sm"
                  ></i>
                  <span data-i18n="btn_add">Agregar</span>
                </button>
                <button
                  onclick="addToComparator()"
                  class="bg-purple-600 hover:bg-purple-500 text-white font-bold py-2.5 px-4 rounded-lg transition-colors flex items-center justify-center gap-2 group text-sm whitespace-nowrap"
                  title="Agregar al Comparador (Max 2)"
                >
                  <i class="fa-solid fa-code-compare"></i>
                  <span data-i18n="btn_vs">VS</span>
                </button>
              </div>
            </div>
          </div>

          <!-- Right: Properties -->
          <div class="glass-card rounded-xl p-6" id="properties-panel">
            <h3
              class="text-sm font-bold text-gray-500 uppercase tracking-wider mb-4"
              data-i18n="sect_properties"
            >
              <i class="fa-solid fa-table-list mr-2"></i>Propiedades Mecánicas
            </h3>
            <div id="properties-grid" class="prop-grid">
              <div
                class="prop-card col-span-full text-center py-12 text-gray-600"
              >
                <i class="fa-solid fa-arrow-left text-3xl mb-3 block"></i>
                <p class="text-sm" data-i18n="properties_placeholder">
                  Selecciona una serie y luego un perfil para ver sus
                  propiedades
                </p>
              </div>
            </div>
          </div>
        </div>

        <!-- Profile List Summary Section -->
        <div class="mt-8 hidden" id="summary-section">
          <div class="glass-card rounded-xl p-6 overflow-hidden mb-6">
            <div class="flex items-center justify-between mb-4">
              <h3
                class="text-sm font-bold text-gray-500 uppercase tracking-wider"
                data-i18n="sect_summary"
              >
                <i class="fa-solid fa-list-check mr-2"></i>Resumen de Perfiles
                Seleccionados
              </h3>
              <div class="flex items-center gap-2 flex-wrap">
                <button
                  onclick="exportToExcel()"
                  class="text-xs bg-green-600 hover:bg-green-500 text-white px-3 py-1.5 rounded-lg transition-all hover:-translate-y-0.5 shadow-lg shadow-green-900/30 flex items-center gap-1.5 font-bold"
                >
                  <i class="fa-solid fa-file-excel"></i>
                  <span data-i18n="btn_export">Exportar Excel</span>
                </button>
                <button
                  onclick="copyTableToClipboard()"
                  class="text-xs bg-gray-700 hover:bg-gray-600 text-white px-3 py-1.5 rounded-lg transition-all hover:-translate-y-0.5 flex items-center gap-1.5 font-bold"
                >
                  <i class="fa-solid fa-clipboard"></i>
                  <span data-i18n="btn_copy">Copiar</span>
                </button>
                <button
                  onclick="saveToLocalStorage()"
                  class="text-xs bg-blue-700 hover:bg-blue-600 text-white px-3 py-1.5 rounded-lg transition-all hover:-translate-y-0.5 flex items-center gap-1.5 font-bold"
                >
                  <i class="fa-solid fa-floppy-disk"></i>
                  <span data-i18n="btn_save">Guardar</span>
                </button>
                <button
                  onclick="loadFromLocalStorage()"
                  class="text-xs bg-amber-600 hover:bg-amber-500 text-white px-3 py-1.5 rounded-lg transition-all hover:-translate-y-0.5 flex items-center gap-1.5 font-bold"
                >
                  <i class="fa-solid fa-folder-open"></i>
                  <span data-i18n="btn_load">Cargar</span>
                </button>
                <button
                  id="btn-clear-list"
                  class="text-xs text-red-400 hover:text-red-300 transition-colors flex items-center gap-1"
                  onclick="clearList()"
                >
                  <i class="fa-solid fa-trash-can"></i>
                  <span data-i18n="btn_clear">Limpiar</span>
                </button>
              </div>
            </div>

            <div class="overflow-x-auto">
              <table class="w-full text-left border-collapse">
                <thead>
                  <tr
                    class="border-b border-gray-700 text-xs text-gray-400 uppercase tracking-wider"
                  >
                    <th
                      class="py-3 px-4 font-semibold text-left"
                      data-i18n="th_mark"
                    >
                      Marca
                    </th>
                    <th
                      class="py-3 px-4 font-semibold text-center w-16"
                      data-i18n="th_qty"
                    >
                      Cant.
                    </th>
                    <th class="py-3 px-4 font-semibold" data-i18n="th_profile">
                      Perfil
                    </th>
                    <th class="py-3 px-4 font-semibold text-right">
                      <span data-i18n="th_len">Largo</span>
                      <span class="text-gray-600 normal-case">(m)</span>
                    </th>
                    <th class="py-3 px-4 font-semibold text-right">
                      <span data-i18n="th_unit_weight">Peso Unit.</span>
                      <span class="text-gray-600 normal-case">(kg/m)</span>
                    </th>
                    <th class="py-3 px-4 font-semibold text-right">
                      <span data-i18n="th_total_weight">Peso Total</span>
                      <span class="text-gray-600 normal-case">(kg)</span>
                    </th>
                    <th class="py-3 px-4 font-semibold text-center w-16"></th>
                  </tr>
                </thead>
                <tbody
                  id="profile-list-body"
                  class="text-sm text-gray-300 divide-y divide-gray-800"
                >
                  <!-- Populated by JS -->
                </tbody>
                <tfoot class="bg-gray-800/30">
                  <tr class="font-bold text-white border-t border-gray-600">
                    <td class="py-4 px-4" colspan="4" data-i18n="total_label">
                      TOTALES:
                    </td>
                    <td
                      class="py-4 px-4 text-right transform translate-x-3 text-gray-500"
                    >
                      —
                    </td>
                    <td
                      class="py-4 px-4 text-right text-bim-blue text-lg"
                      id="grand-total-weight"
                    >
                      0.00
                      <span class="text-xs text-gray-500 font-medium ml-1"
                        >kg</span
                      >
                    </td>
                    <td></td>
                  </tr>
                </tfoot>
              </table>
            </div>
          </div>
        </div>

        <!-- Classification by Nominal Weight -->
        <div class="mt-6 hidden" id="classification-section">
          <div class="glass-card rounded-xl p-6 overflow-hidden mb-6">
            <div class="flex items-center justify-between mb-4 flex-wrap gap-3">
              <h3
                class="text-sm font-bold text-gray-500 uppercase tracking-wider"
              >
                <i class="fa-solid fa-weight-hanging mr-2"></i
                ><span data-i18n="sect_classification"
                  >Clasificación por Nominal Weight</span
                >
              </h3>
              <div class="flex items-center gap-2">
                <label
                  class="text-xs text-gray-400"
                  for="conn-pct"
                  data-i18n="lbl_connections"
                  >Conexiones:</label
                >
                <input
                  type="number"
                  id="conn-pct"
                  value="10"
                  min="0"
                  max="100"
                  step="1"
                  class="w-16 bg-gray-800 border border-gray-600 rounded px-2 py-1 text-sm text-white text-center focus:border-bim-blue focus:outline-none"
                  onchange="updateClassification()"
                  oninput="updateClassification()"
                />
                <span class="text-xs text-gray-500">%</span>
              </div>
            </div>
            <div class="overflow-x-auto">
              <table class="w-full text-left border-collapse">
                <thead>
                  <tr
                    class="border-b border-gray-700 text-xs text-gray-400 uppercase tracking-wider"
                  >
                    <th
                      class="py-3 px-4 font-semibold text-left"
                      data-i18n="cls_desc"
                    >
                      Descripción
                    </th>
                    <th
                      class="py-3 px-4 font-semibold text-right w-24"
                      data-i18n="cls_unit"
                    >
                      Unidad
                    </th>
                    <th
                      class="py-3 px-4 font-semibold text-right w-32"
                      data-i18n="cls_qty"
                    >
                      Cantidad
                    </th>
                  </tr>
                </thead>
                <tbody id="classification-body" class="text-sm text-gray-300">
                  <!-- Populated by JS -->
                </tbody>
              </table>
            </div>
            <!-- Donut Chart -->
            <div class="mt-6 flex justify-center">
              <div
                style="
                  position: relative;
                  width: 100%;
                  max-width: 320px;
                  height: 220px;
                "
              >
                <canvas id="weight-donut-chart"></canvas>
              </div>
            </div>
            <div
              class="mt-4 pt-3 border-t border-gray-600 flex items-center justify-between"
            >
              <span
                class="text-sm font-bold text-white"
                data-i18n="cls_total_steel"
                >Total Acero (con conexiones):</span
              >
              <span
                class="text-lg font-extrabold text-bim-blue"
                id="classification-total"
                >0.00 <span class="text-xs text-gray-500">kg</span></span
              >
            </div>
          </div>
        </div>

        <!-- Comparator Section -->
        <div class="mt-8 hidden" id="comparator-section">
          <div class="glass-card rounded-xl p-6 overflow-hidden mb-6">
            <div class="flex items-center justify-between mb-4">
              <h3
                class="text-sm font-bold text-gray-500 uppercase tracking-wider"
                data-i18n="sect_comparator"
              >
                <i class="fa-solid fa-code-compare mr-2"></i>Comparador de
                Perfiles
              </h3>
              <button
                onclick="clearComparator()"
                class="text-xs text-red-400 hover:text-red-300 transition-colors flex items-center gap-1"
              >
                <i class="fa-solid fa-trash-can"></i>
                <span data-i18n="btn_clear_local">Limpiar Local</span>
              </button>
            </div>

            <div class="overflow-x-auto">
              <table class="w-full text-left border-collapse">
                <thead>
                  <tr
                    class="border-b border-gray-700 text-xs text-gray-400 uppercase tracking-wider"
                  >
                    <th
                      class="py-3 px-4 font-semibold w-1/4"
                      data-i18n="cmp_prop"
                    >
                      Propiedad
                    </th>
                    <th
                      class="py-3 px-4 font-semibold text-center w-1/4 text-bim-blue"
                      id="comp-name-a"
                      data-i18n="cmp_profile_a"
                    >
                      Perfil A
                    </th>
                    <th
                      class="py-3 px-4 font-semibold text-center w-1/4"
                      id="comp-name-b"
                      data-i18n="cmp_profile_b"
                    >
                      Perfil B
                    </th>
                    <th
                      class="py-3 px-4 font-semibold text-right w-1/4"
                      data-i18n="cmp_diff"
                    >
                      Diferencia
                    </th>
                  </tr>
                </thead>
                <tbody
                  id="comparator-body"
                  class="text-sm text-gray-300 divide-y divide-gray-800"
                >
                  <!-- Populated by JS -->
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- Footer -->
    <footer class="py-8 border-t border-gray-800 mt-12">
      <div class="max-w-7xl mx-auto px-4 text-center">
        <p class="text-gray-500 text-sm" data-i18n="footer_text">
          &copy; 2026 Andrés Gallo P. — Herramientas para Proyectistas
          Estructurales
        </p>
      </div>
    </footer>

    <script src="icha_data.js"></script>
    <script src="i18n.js"></script>
    <script>
      // ==================== STATE ====================
      let currentSeries = null;
      let selectedProfile = null;
      const profileList = [];
      let highlightedIndex = -1;

      // ==================== PROPERTY LABELS ====================
      // ==================== PROPERTY LABELS ====================
      const PROP_LABELS = {
        weight: {
          i18n: "prop_weight",
          unit: "kg/m",
          icon: "fa-weight-hanging",
        },
        A_cm2: { i18n: "prop_area", unit: "cm²", icon: "fa-vector-square" },
        H_mm: { i18n: "prop_h", unit: "mm", icon: "fa-arrows-up-down" },
        B_mm: { i18n: "prop_b", unit: "mm", icon: "fa-arrows-left-right" },
        e_mm: { i18n: "prop_e", unit: "mm", icon: "fa-ruler" },
        t_mm: { i18n: "prop_t", unit: "mm", icon: "fa-ruler" },
        C_mm: { i18n: "prop_c", unit: "mm", icon: "fa-ruler" },
        Ix_cm4: { i18n: "prop_ix", unit: "cm⁴", icon: "fa-rotate" },
        Wx_cm3: { i18n: "prop_wx", unit: "cm³", icon: "fa-cube" },
        ix_cm: { i18n: "prop_ix_rad", unit: "cm", icon: "fa-circle-dot" },
        Iy_cm4: { i18n: "prop_iy", unit: "cm⁴", icon: "fa-rotate" },
        Wy_cm3: { i18n: "prop_wy", unit: "cm³", icon: "fa-cube" },
        iy_cm: { i18n: "prop_iy_rad", unit: "cm", icon: "fa-circle-dot" },
        xy_cm: { i18n: "prop_xy", unit: "cm", icon: "fa-crosshairs" },
        x_cm: { i18n: "prop_x", unit: "cm", icon: "fa-crosshairs" },
        y_cm: { i18n: "prop_y", unit: "cm", icon: "fa-crosshairs" },
        X_cm: { i18n: "prop_X", unit: "cm", icon: "fa-crosshairs" },
        iu_cm: { i18n: "prop_iu", unit: "cm", icon: "fa-circle-dot" },
        iv_cm: { i18n: "prop_iv", unit: "cm", icon: "fa-circle-dot" },
      };

      // ==================== SERIES SELECTOR ====================
      function renderSeriesSelector() {
        const container = document.getElementById("series-selector");
        container.innerHTML = "";
        for (const [key, series] of Object.entries(ICHA_CATALOG)) {
          const btn = document.createElement("button");
          btn.className =
            "profile-btn glass-card rounded-xl p-3 flex flex-col items-center justify-center gap-1 cursor-pointer border border-transparent";
          btn.innerHTML = `
            <i class="${series.icon} profile-icon text-gray-400 text-lg"></i>
            <span class="text-xs font-bold text-gray-400 leading-tight text-center">${key.replace("_desig", "")}</span>
            <span class="text-[10px] text-gray-600 leading-tight text-center truncate w-full">${series.name.split("(")[0].trim()}</span>
          `;
          btn.addEventListener("click", () => selectSeries(key));
          container.appendChild(btn);
        }
      }

      function selectSeries(key) {
        currentSeries = key;
        selectedProfile = null;
        highlightedIndex = -1;

        // Update buttons
        document
          .querySelectorAll("#series-selector .profile-btn")
          .forEach((btn, i) => {
            const seriesKey = Object.keys(ICHA_CATALOG)[i];
            btn.classList.toggle("active", seriesKey === key);
          });

        // Reset search
        const searchInput = document.getElementById("profile-search");
        searchInput.value = "";
        searchInput.placeholder = `${t("search_placeholder_prefix")} ${ICHA_CATALOG[key].name}...`;
        searchInput.focus();

        // Show all profiles for this series
        showSearchResults("");

        // Hide selected profile
        document
          .getElementById("selected-profile-display")
          .classList.add("hidden");
        document.getElementById("add-controls").style.display = "none";

        // Reset properties
        document.getElementById("properties-grid").innerHTML = `
          <div class="prop-card col-span-full text-center py-8 text-gray-600">
            <i class="fa-solid fa-search text-2xl mb-2 block"></i>
            <p class="text-sm">${ICHA_CATALOG[key].profiles.length} ${t("msg_profiles_available")}</p>
          </div>
        `;
      }

      // ==================== SEARCH ====================
      function showSearchResults(query) {
        if (!currentSeries) return;
        const container = document.getElementById("search-results");
        const profiles = ICHA_CATALOG[currentSeries].profiles;
        const q = query.toLowerCase().replace(/\s+/g, "");

        const filtered = profiles.filter((p) => {
          const desig = p.designation.toLowerCase().replace(/\s+/g, "");
          return desig.includes(q);
        });

        if (filtered.length === 0) {
          container.innerHTML = `<div class="p-4 text-center text-gray-500 text-sm">${t("msg_no_results")}</div>`;
          container.classList.remove("hidden");
          return;
        }

        container.innerHTML = filtered
          .map(
            (p, i) => `
          <div class="dropdown-item px-4 py-2.5 cursor-pointer text-sm flex items-center justify-between border-b border-gray-800/50 last:border-0"
               data-index="${profiles.indexOf(p)}" data-filtered-index="${i}">
            <span class="font-semibold text-white">${p.designation}</span>
            <span class="text-xs text-gray-500">${p.weight} kg/m</span>
          </div>`,
          )
          .join("");

        container.classList.remove("hidden");
        highlightedIndex = -1;

        // Add click handlers
        container.querySelectorAll(".dropdown-item").forEach((item) => {
          item.addEventListener("click", () => {
            const idx = parseInt(item.dataset.index);
            selectProfile(profiles[idx]);
            container.classList.add("hidden");
          });
        });
      }

      // ==================== SELECT PROFILE ====================
      function selectProfile(profile) {
        // Enrich profile with missing dimensions if needed for display
        if (profile.H_mm === undefined)
          profile.H_mm = getHeightFromDesig(profile.designation);

        if (profile.B_mm === undefined) {
          const w = getWidthFromDesig(profile.designation);
          if (w !== null) {
            profile.B_mm = w;
          } else if (
            currentSeries === "L" ||
            profile.designation.trim().startsWith("L ")
          ) {
            // Fallback for Equal Angles only
            profile.B_mm = profile.H_mm;
          }
        }

        selectedProfile = profile;
        const searchInput = document.getElementById("profile-search");
        searchInput.value = profile.designation;

        // Show selected profile
        document
          .getElementById("selected-profile-display")
          .classList.remove("hidden");
        document.getElementById("selected-profile-name").textContent =
          profile.designation;
        document.getElementById("selected-weight").textContent =
          profile.weight.toFixed(1);
        document.getElementById("selected-area").textContent = (
          profile.A_cm2 || 0
        ).toFixed(1);

        // Show add controls
        document.getElementById("add-controls").style.display = "block";

        // Render properties
        renderProperties(profile);

        // Render SVG cross-section
        renderSvgDiagram(profile);
      }

      function renderProperties(profile) {
        const grid = document.getElementById("properties-grid");
        let html = "";

        // Priority order for properties
        const order = [
          "weight",
          "A_cm2",
          "H_mm",
          "B_mm",
          "e_mm",
          "t_mm",
          "Ix_cm4",
          "Iy_cm4",
          "Wx_cm3",
          "Wy_cm3",
          "ix_cm",
          "iy_cm",
          "C_mm",
          "xy_cm",
          "x_cm",
          "y_cm",
          "X_cm",
          "iu_cm",
          "iv_cm",
        ];

        for (const key of order) {
          if (profile[key] === undefined || profile[key] === null) continue;
          const meta = PROP_LABELS[key];
          if (!meta) continue;

          const isWeight = key === "weight";
          html += `
            <div class="prop-card ${isWeight ? "border-blue-500/30 bg-blue-500/5" : ""}">
              <div class="flex items-center gap-2 mb-1">
                <i class="fa-solid ${meta.icon} text-[10px] ${isWeight ? "text-bim-blue" : "text-gray-600"}"></i>
                <span class="text-xs text-gray-500 font-medium">${t(meta.i18n)}</span>
              </div>
              <div class="flex items-baseline gap-1">
                <span class="text-lg font-extrabold ${isWeight ? "text-bim-blue" : "text-white"}">${formatNumber(profile[key])}</span>
                <span class="text-[10px] text-gray-500">${meta.unit}</span>
              </div>
            </div>
          `;
        }

        grid.innerHTML =
          html ||
          `<div class="col-span-full text-center py-8 text-gray-500">Sin propiedades disponibles</div>`;
      }

      function formatNumber(n) {
        if (n === null || n === undefined) return "—";
        if (Math.abs(n) >= 10000) return n.toLocaleString("es-CL");
        if (Number.isInteger(n)) return n.toString();
        return n.toFixed(n < 10 ? 2 : 1);
      }

      // ==================== SVG CROSS-SECTION ====================
      const SZ = 240,
        CX = SZ / 2,
        CY = SZ / 2,
        PAD = 45;

      function dimLine(x1, y1, x2, y2, label, offset = 0, color = "#60a5fa") {
        const isV = Math.abs(x1 - x2) < 2;
        const ox = isV ? offset : 0,
          oy = isV ? 0 : offset;
        const mx = (x1 + x2) / 2 + ox,
          my = (y1 + y2) / 2 + oy;
        const tox = isV ? (offset > 0 ? 8 : -8) : 0;
        const toy = isV ? 0 : offset > 0 ? 12 : -6;
        const tx = Math.max(24, Math.min(SZ - 24, mx + tox));
        const ty = Math.max(10, Math.min(SZ - 4, my + toy));
        return `<line x1="${x1 + ox}" y1="${y1 + oy}" x2="${x2 + ox}" y2="${y2 + oy}" stroke="${color}" stroke-width="0.8" stroke-dasharray="3,2" opacity="0.7"/>
                <text x="${tx}" y="${ty}" fill="${color}" font-size="10" font-family="Inter" font-weight="600" text-anchor="middle">${label}</text>`;
      }

      function getHeightFromDesig(designation) {
        // Find first number in designation
        const clean = designation.replace(/,/, ".").trim();
        const m = clean.match(/(\d+(\.\d+)?)/);

        if (m) {
          const val = parseFloat(m[1]);

          // ICHA Series usually define Height in CM in the designation (IN 100 = 100cm = 1000mm)
          const cmSeries =
            /^(IN|HN|IP|PH|IE|C|CA|IC|ICA|L|TL|XL|Cuad|Rect|Box)\b/i;

          if (cmSeries.test(clean)) {
            return val * 10;
          }

          // Default heuristic
          return val < 100 ? val * 10 : val;
        }
        return 300;
      }

      function getWidthFromDesig(designation) {
        // Only valid for Angles (L) or similar where format is H*B
        if (!designation.trim().startsWith("L")) {
          return null;
        }

        const clean = designation.replace(/,/, ".");
        const m = clean.match(/(\d+(\.\d+)?)\*(\d+(\.\d+)?)/);
        if (m) {
          const val = parseFloat(m[3]);
          return val < 100 ? val * 10 : val;
        }
        return null;
      }

      // H / I shape (IN, IP, HN, PH)
      function buildICHAHSvg(h, b, s, t) {
        const sc = Math.min((SZ - 2 * PAD) / h, (SZ - 2 * PAD) / b);
        const H = h * sc,
          B = b * sc,
          S = Math.max(s * sc, 4),
          T = Math.max(t * sc, 4);
        const x = CX,
          y = CY;
        const shape = `<polygon points="${x - B / 2},${y - H / 2} ${x + B / 2},${y - H / 2} ${x + B / 2},${y - H / 2 + T} ${x + S / 2},${y - H / 2 + T} ${x + S / 2},${y + H / 2 - T} ${x + B / 2},${y + H / 2 - T} ${x + B / 2},${y + H / 2} ${x - B / 2},${y + H / 2} ${x - B / 2},${y + H / 2 - T} ${x - S / 2},${y + H / 2 - T} ${x - S / 2},${y - H / 2 + T} ${x - B / 2},${y - H / 2 + T}" fill="rgba(59,130,246,0.15)" stroke="#3b82f6" stroke-width="2"/>`;
        let dims = dimLine(
          x - B / 2,
          y - H / 2,
          x - B / 2,
          y + H / 2,
          `h=${h}`,
          -22,
        );
        dims += dimLine(
          x - B / 2,
          y + H / 2,
          x + B / 2,
          y + H / 2,
          `b=${b}`,
          18,
        );
        dims += `<text x="${x + S / 2 + 6}" y="${y + 4}" fill="#60a5fa" font-size="9" font-family="Inter" font-weight="600">t=${s}</text>`;
        dims += `<text x="${x + B / 2 + 6}" y="${y - H / 2 + T / 2 + 3}" fill="#60a5fa" font-size="9" font-family="Inter" font-weight="600">e=${t}</text>`;
        return `<svg viewBox="0 0 ${SZ} ${SZ}" class="w-full h-full max-w-[240px]">${shape}${dims}</svg>`;
      }

      // Channel C shape
      function buildICHACSvg(h, b, e, t) {
        const bVal = b || 80;
        const sc = Math.min((SZ - 2 * PAD) / h, (SZ - 2 * PAD) / (bVal * 2));
        const H = h * sc,
          B = bVal * sc,
          T = Math.max((t || e) * sc, 3);
        const x = CX,
          top = CY - H / 2;
        const pts = `${x - B},${top} ${x},${top} ${x},${top + T} ${x - B + T},${top + T} ${x - B + T},${top + H - T} ${x},${top + H - T} ${x},${top + H} ${x - B},${top + H}`;
        const shape = `<polygon points="${pts}" fill="rgba(59,130,246,0.15)" stroke="#3b82f6" stroke-width="2"/>`;
        let dims = dimLine(x + 4, top, x + 4, top + H, `h=${h}`, 14);
        dims += dimLine(x - B, top + H, x, top + H, `b=${bVal}`, 16);
        dims += `<text x="${x + 6}" y="${top + T + 12}" fill="#60a5fa" font-size="9" font-family="Inter" font-weight="600">e=${e || t}</text>`;
        return `<svg viewBox="0 0 ${SZ} ${SZ}" class="w-full h-full max-w-[240px]">${shape}${dims}</svg>`;
      }

      // Stiffened channel (CA)
      function buildICHACASvg(h, b, e, t, c) {
        const sc = Math.min(
          (SZ - 2 * PAD) / h,
          (SZ - 2 * PAD) / ((b || 80) * 2),
        );
        const H = h * sc,
          B = Math.max((b || 50) * sc, 8),
          T = Math.max((t || e) * sc, 3);
        const C = c ? Math.max(c * sc, 6) : 0;
        const left = CX - B / 2,
          top = CY - H / 2;
        let pts;
        if (C > 0) {
          pts = `${left},${top} ${left + B},${top} ${left + B},${top + C} ${left + B - T},${top + C} ${left + B - T},${top + T} ${left + T},${top + T} ${left + T},${top + H - T} ${left + B - T},${top + H - T} ${left + B - T},${top + H - C} ${left + B},${top + H - C} ${left + B},${top + H} ${left},${top + H}`;
        } else {
          pts = `${left},${top} ${left + B},${top} ${left + B},${top + T} ${left + T},${top + T} ${left + T},${top + H - T} ${left + B},${top + H - T} ${left + B},${top + H} ${left},${top + H}`;
        }
        const shape = `<polygon points="${pts}" fill="rgba(59,130,246,0.15)" stroke="#3b82f6" stroke-width="2"/>`;
        let dims = dimLine(
          left + B + 4,
          top,
          left + B + 4,
          top + H,
          `h=${h}`,
          16,
        );
        dims += dimLine(left, top + H, left + B, top + H, `b=${b || 50}`, 16);
        dims += `<text x="${left + B + 6}" y="${top + T / 2 + 3}" fill="#60a5fa" font-size="9" font-family="Inter" font-weight="600">e=${e || t}</text>`;
        if (C > 0)
          dims += `<text x="${left + B + 6}" y="${top + H - C / 2 + 3}" fill="#60a5fa" font-size="9" font-family="Inter" font-weight="600">c=${c}</text>`;
        return `<svg viewBox="0 0 ${SZ} ${SZ}" class="w-full h-full max-w-[240px]">${shape}${dims}</svg>`;
      }

      // Angle L shape
      function buildICHALSvg(h, b, e) {
        const bVal = b || h;
        const maxD = Math.max(h, bVal);
        const sc = (SZ - 2 * PAD) / maxD;
        const H = h * sc,
          B = bVal * sc,
          T = Math.max(e * sc, 3);
        const x = CX - B / 2,
          top = CY - H / 2;
        const pts = `${x},${top} ${x + T},${top} ${x + T},${top + H - T} ${x + B},${top + H - T} ${x + B},${top + H} ${x},${top + H}`;
        const shape = `<polygon points="${pts}" fill="rgba(59,130,246,0.15)" stroke="#3b82f6" stroke-width="2"/>`;
        let dims = dimLine(x, top, x, top + H, `h=${h}`, -20);
        dims += dimLine(x, top + H, x + B, top + H, `b=${bVal}`, 16);
        dims += `<text x="${x + T + 6}" y="${top + 20}" fill="#60a5fa" font-size="9" font-family="Inter" font-weight="600">e=${e}</text>`;
        return `<svg viewBox="0 0 ${SZ} ${SZ}" class="w-full h-full max-w-[240px]">${shape}${dims}</svg>`;
      }

      // Double angle TL shape
      function buildICHATLSvg(h, b, e) {
        const bVal = b || h;
        const sc =
          Math.min((SZ - 2 * PAD) / h, (SZ - 2 * PAD) / (bVal * 2)) * 0.85;
        const H = h * sc,
          B = bVal * sc,
          T = Math.max(e * sc, 3);
        const gap = 6;
        // Left angle (mirrored)
        const lx = CX - gap / 2,
          top = CY - H / 2;
        const lPts = `${lx},${top} ${lx - T},${top} ${lx - T},${top + H - T} ${lx - B},${top + H - T} ${lx - B},${top + H} ${lx},${top + H}`;
        // Right angle
        const rx = CX + gap / 2;
        const rPts = `${rx},${top} ${rx + T},${top} ${rx + T},${top + H - T} ${rx + B},${top + H - T} ${rx + B},${top + H} ${rx},${top + H}`;
        const shape = `<polygon points="${lPts}" fill="rgba(59,130,246,0.15)" stroke="#3b82f6" stroke-width="2"/>
                        <polygon points="${rPts}" fill="rgba(59,130,246,0.15)" stroke="#3b82f6" stroke-width="2"/>`;
        let dims = dimLine(lx - B, top, lx - B, top + H, `h=${h}`, -18);
        dims += dimLine(rx, top + H, rx + B, top + H, `b=${bVal}`, 16);
        dims += `<text x="${rx + T + 6}" y="${top + 14}" fill="#60a5fa" font-size="9" font-family="Inter" font-weight="600">e=${e}</text>`;
        return `<svg viewBox="0 0 ${SZ} ${SZ}" class="w-full h-full max-w-[240px]">${shape}${dims}</svg>`;
      }

      // Cross angle XL shape
      function buildICHAXLSvg(h, b, e) {
        const bVal = b || h;
        const maxD = Math.max(h, bVal);
        const sc = ((SZ - 2 * PAD) / maxD) * 0.7;
        const H = h * sc,
          B = bVal * sc,
          T = Math.max(e * sc, 3);
        const gap = 6;
        const ax = CX - gap / 2,
          ay = CY - gap / 2;
        const aPts = `${ax},${ay} ${ax},${ay - H} ${ax - T},${ay - H} ${ax - T},${ay - T} ${ax - B},${ay - T} ${ax - B},${ay}`;
        const bx = CX + gap / 2,
          by = CY + gap / 2;
        const bPts = `${bx},${by} ${bx},${by + H} ${bx + T},${by + H} ${bx + T},${by + T} ${bx + B},${by + T} ${bx + B},${by}`;
        const shape = `<polygon points="${aPts}" fill="rgba(59,130,246,0.15)" stroke="#3b82f6" stroke-width="2" stroke-linejoin="round"/>
                        <polygon points="${bPts}" fill="rgba(59,130,246,0.15)" stroke="#3b82f6" stroke-width="2" stroke-linejoin="round"/>`;
        let dims = dimLine(ax - T, ay - H, ax - T, ay, `h=${h}`, -18);
        dims += dimLine(ax - B, ay, ax, ay, `b=${bVal}`, 16);
        dims += `<text x="${ax + 8}" y="${ay - H + 14}" fill="#60a5fa" font-size="9" font-family="Inter" font-weight="600">e=${e}</text>`;
        return `<svg viewBox="0 0 ${SZ} ${SZ}" class="w-full h-full max-w-[240px]">${shape}${dims}</svg>`;
      }

      // Double channel IC shape
      function buildICHAICSvg(h, b, e, t) {
        const bVal = b || 80;
        const sc =
          Math.min((SZ - 2 * PAD) / h, (SZ - 2 * PAD) / (bVal * 2)) * 0.9;
        const H = h * sc,
          B = bVal * sc,
          T = Math.max((t || e) * sc, 3);
        const gap = 4;
        const top = CY - H / 2;
        // Left channel (opening left)
        const lx = CX - gap / 2;
        const lPts = `${lx},${top} ${lx - B},${top} ${lx - B},${top + T} ${lx - T},${top + T} ${lx - T},${top + H - T} ${lx - B},${top + H - T} ${lx - B},${top + H} ${lx},${top + H}`;
        // Right channel (opening right)
        const rx = CX + gap / 2;
        const rPts = `${rx},${top} ${rx + B},${top} ${rx + B},${top + T} ${rx + T},${top + T} ${rx + T},${top + H - T} ${rx + B},${top + H - T} ${rx + B},${top + H} ${rx},${top + H}`;
        const shape = `<polygon points="${lPts}" fill="rgba(59,130,246,0.15)" stroke="#3b82f6" stroke-width="2"/>
                        <polygon points="${rPts}" fill="rgba(59,130,246,0.15)" stroke="#3b82f6" stroke-width="2"/>`;
        let dims = dimLine(rx + B + 4, top, rx + B + 4, top + H, `h=${h}`, 16);
        dims += dimLine(rx, top + H, rx + B, top + H, `b=${bVal}`, 16);
        dims += `<text x="${rx + T + 6}" y="${top + T + 12}" fill="#60a5fa" font-size="9" font-family="Inter" font-weight="600">e=${e || t}</text>`;
        return `<svg viewBox="0 0 ${SZ} ${SZ}" class="w-full h-full max-w-[240px]">${shape}${dims}</svg>`;
      }

      // Double stiffened channel ICA shape
      function buildICHAICASvg(h, b, e, t, c) {
        const bVal = b || 80;
        const sc =
          Math.min((SZ - 2 * PAD) / h, (SZ - 2 * PAD) / (bVal * 2)) * 0.9;
        const H = h * sc,
          B = Math.max(bVal * sc, 8),
          T = Math.max((t || e) * sc, 3);
        const C = c ? Math.max(c * sc, 6) : 0;
        const gap = 4;
        const top = CY - H / 2;
        // Left stiffened channel
        const lx = CX - gap / 2;
        let lPts;
        if (C > 0) {
          lPts = `${lx},${top} ${lx - B},${top} ${lx - B},${top + C} ${lx - B + T},${top + C} ${lx - B + T},${top + T} ${lx - T},${top + T} ${lx - T},${top + H - T} ${lx - B + T},${top + H - T} ${lx - B + T},${top + H - C} ${lx - B},${top + H - C} ${lx - B},${top + H} ${lx},${top + H}`;
        } else {
          lPts = `${lx},${top} ${lx - B},${top} ${lx - B},${top + T} ${lx - T},${top + T} ${lx - T},${top + H - T} ${lx - B},${top + H - T} ${lx - B},${top + H} ${lx},${top + H}`;
        }
        // Right stiffened channel (mirrored)
        const rx = CX + gap / 2;
        let rPts;
        if (C > 0) {
          rPts = `${rx},${top} ${rx + B},${top} ${rx + B},${top + C} ${rx + B - T},${top + C} ${rx + B - T},${top + T} ${rx + T},${top + T} ${rx + T},${top + H - T} ${rx + B - T},${top + H - T} ${rx + B - T},${top + H - C} ${rx + B},${top + H - C} ${rx + B},${top + H} ${rx},${top + H}`;
        } else {
          rPts = `${rx},${top} ${rx + B},${top} ${rx + B},${top + T} ${rx + T},${top + T} ${rx + T},${top + H - T} ${rx + B},${top + H - T} ${rx + B},${top + H} ${rx},${top + H}`;
        }
        const shape = `<polygon points="${lPts}" fill="rgba(59,130,246,0.15)" stroke="#3b82f6" stroke-width="2"/>
                        <polygon points="${rPts}" fill="rgba(59,130,246,0.15)" stroke="#3b82f6" stroke-width="2"/>`;
        let dims = dimLine(rx + B + 4, top, rx + B + 4, top + H, `h=${h}`, 16);
        dims += dimLine(rx, top + H, rx + B, top + H, `b=${bVal}`, 16);
        return `<svg viewBox="0 0 ${SZ} ${SZ}" class="w-full h-full max-w-[240px]">${shape}${dims}</svg>`;
      }

      // Box (Cajón) shape
      function buildICHABoxSvg(h, b, e) {
        const sc = Math.min((SZ - 2 * PAD) / h, (SZ - 2 * PAD) / b);
        const H = h * sc,
          B = b * sc,
          T = Math.max(e * sc, 3);
        const x = CX - B / 2,
          y = CY - H / 2;
        const outer = `<rect x="${x}" y="${y}" width="${B}" height="${H}" fill="none" stroke="#3b82f6" stroke-width="2" rx="3"/>`;
        const inner = `<rect x="${x + T}" y="${y + T}" width="${B - 2 * T}" height="${H - 2 * T}" fill="rgba(11,18,32,0.9)" stroke="#3b82f6" stroke-width="1.5" stroke-dasharray="4,2" rx="1"/>`;
        const fill = `<rect x="${x}" y="${y}" width="${B}" height="${H}" fill="rgba(59,130,246,0.12)" rx="3"/>`;
        const innerClear = `<rect x="${x + T}" y="${y + T}" width="${B - 2 * T}" height="${H - 2 * T}" fill="rgba(11,18,32,0.85)" rx="1"/>`;
        let dims = dimLine(x, y, x, y + H, `h=${h}`, -22);
        dims += dimLine(x, y + H, x + B, y + H, `b=${b}`, 16);
        dims += `<text x="${CX}" y="${CY + 4}" fill="#60a5fa" font-size="10" font-family="Inter" font-weight="600" text-anchor="middle">e=${e}</text>`;
        return `<svg viewBox="0 0 ${SZ} ${SZ}" class="w-full h-full max-w-[240px]">${fill}${innerClear}${outer}${inner}${dims}</svg>`;
      }

      // Map series to SVG builder
      function renderSvgDiagram(profile) {
        const container = document.getElementById("svg-container");
        const desigText = document.getElementById("designation-text");
        desigText.textContent = profile.designation;

        const h = profile.H_mm || getHeightFromDesig(profile.designation);
        const b = profile.B_mm || getWidthFromDesig(profile.designation);
        const e = profile.e_mm || 8;
        const t = profile.t_mm || e;
        const c = profile.C_mm || 0;

        let svg = "";
        const series = currentSeries;

        if (["IN", "IP", "HN", "PH"].includes(series)) {
          svg = buildICHAHSvg(h, b, t, e);
        } else if (series === "C") {
          svg = buildICHACSvg(h, b, t, e);
        } else if (series === "CA") {
          svg = buildICHACASvg(h, b, t, e, c);
        } else if (series === "IC") {
          svg = buildICHAICSvg(h, b, t, e);
        } else if (series === "ICA") {
          svg = buildICHAICASvg(h, b, t, e, c);
        } else if (series === "L" || series === "L_desig") {
          svg = buildICHALSvg(h, b, e);
        } else if (series === "TL") {
          svg = buildICHATLSvg(h, b, e);
        } else if (series === "XL") {
          svg = buildICHAXLSvg(h, b, e);
        } else if (series === "CAJON") {
          svg = buildICHABoxSvg(h, b, e);
        } else {
          // Fallback: generic H shape
          svg = buildICHAHSvg(h, b, t, e);
        }

        if (window.update3DView) {
          window.update3DView(profile);
        }

        container.innerHTML = svg;
      }

      function addToList() {
        if (!selectedProfile) return;
        const mark = document.getElementById("list-mark").value || "—";
        const len = parseFloat(document.getElementById("list-len").value) || 6;
        const qty = parseInt(document.getElementById("list-qty").value) || 1;

        profileList.push({
          mark,
          qty,
          designation: selectedProfile.designation,
          length: len,
          unitWeight: selectedProfile.weight,
          totalWeight: qty * len * selectedProfile.weight,
        });

        renderProfileList();
        document.getElementById("list-mark").value = "";
      }

      function removeFromList(index) {
        profileList.splice(index, 1);
        renderProfileList();
      }

      function clearList() {
        if (confirm(t("msg_confirm_clear"))) {
          profileList.length = 0;
          renderProfileList();
          localStorage.removeItem("bim-catalogo-icha-list");
        }
      }

      function renderProfileList() {
        const tbody = document.getElementById("profile-list-body");
        const section = document.getElementById("summary-section");
        const classSection = document.getElementById("classification-section");

        if (profileList.length === 0) {
          section.classList.add("hidden");
          classSection.classList.add("hidden");
          return;
        }
        section.classList.remove("hidden");
        classSection.classList.remove("hidden");

        let totalWeight = 0;
        tbody.innerHTML = profileList
          .map((item, i) => {
            totalWeight += item.totalWeight;
            const bgClass = i % 2 === 0 ? "" : "bg-gray-800/20";
            return `
              <tr class="${bgClass} hover:bg-gray-700/30 transition-colors">
                <td class="py-3 px-4 font-semibold text-white">${item.mark}</td>
                <td class="py-3 px-4 text-center font-bold">${item.qty}</td>
                <td class="py-3 px-4 text-bim-blue font-semibold">${item.designation}</td>
                <td class="py-3 px-4 text-right">${item.length.toFixed(1)}</td>
                <td class="py-3 px-4 text-right">${item.unitWeight.toFixed(2)}</td>
                <td class="py-3 px-4 text-right font-bold text-white">${item.totalWeight.toFixed(2)}</td>
                <td class="py-3 px-4 text-center">
                  <button onclick="removeFromList(${i})" class="text-red-500 hover:text-red-400 transition-colors">
                    <i class="fa-solid fa-xmark"></i>
                  </button>
                </td>
              </tr>`;
          })
          .join("");

        document.getElementById("grand-total-weight").innerHTML =
          `${totalWeight.toFixed(2)} <span class="text-xs text-gray-500 font-medium ml-1">kg</span>`;
        updateClassification();
      }

      // ==================== CLASSIFICATION ====================
      function updateClassification() {
        const categories = [
          { name: t("cat_light"), min: 0, max: 25 },
          { name: t("cat_medium"), min: 25, max: 50 },
          { name: t("cat_heavy"), min: 50, max: 100 },
          {
            name: t("cat_extra"),
            min: 100,
            max: Infinity,
          },
        ];

        const catWeights = categories.map(() => 0);
        profileList.forEach((item) => {
          for (let i = 0; i < categories.length; i++) {
            if (
              item.unitWeight >= categories[i].min &&
              item.unitWeight < categories[i].max
            ) {
              catWeights[i] += item.totalWeight;
              break;
            }
          }
        });

        const tbody = document.getElementById("classification-body");
        const totalWeight = catWeights.reduce((a, b) => a + b, 0);
        const connPct =
          parseFloat(document.getElementById("conn-pct").value) || 10;
        const connection = totalWeight * (connPct / 100);
        const grandTotal = totalWeight + connection;

        tbody.innerHTML =
          categories
            .map((cat, i) => {
              const bgClass = i % 2 === 0 ? "" : "bg-gray-800/20";
              return `
              <tr class="${bgClass} border-b border-gray-800">
                <td class="py-3 px-4">${cat.name}</td>
                <td class="py-3 px-4 text-right text-gray-500">kg</td>
                <td class="py-3 px-4 text-right font-bold text-white">${catWeights[i].toFixed(2)}</td>
              </tr>`;
            })
            .join("") +
          `<tr class="border-b border-gray-800 bg-gray-800/20">
            <td class="py-3 px-4 font-semibold text-yellow-400">+ ${connPct}% ${t("chart_conns")}</td>
            <td class="py-3 px-4 text-right text-gray-500">kg</td>
            <td class="py-3 px-4 text-right font-bold text-yellow-400">${connection.toFixed(2)}</td>
          </tr>`;

        document.getElementById("classification-total").innerHTML =
          `${grandTotal.toFixed(2)} <span class="text-xs text-gray-500">kg</span>`;

        // ── Render Donut Chart ──
        renderDonutChart(categories, catWeights, connection);
      }

      // ==================== DONUT CHART ====================
      let donutChart = null;
      function renderDonutChart(categories, catWeights, connection) {
        const ctx = document.getElementById("weight-donut-chart");
        if (!ctx) return;
        if (donutChart) donutChart.destroy();
        const labels = categories
          .map((c) => c.name.split("≤")[0].trim()) // Hacky adaptation, or just use t(chart_light) etc directly
          .concat([t("chart_conns")]);
        const data = [...catWeights, connection];
        const colors = ["#3b82f6", "#06b6d4", "#f59e0b", "#ef4444", "#8b5cf6"];
        donutChart = new Chart(ctx, {
          type: "doughnut",
          data: {
            labels: labels,
            datasets: [
              {
                data: data,
                backgroundColor: colors,
                borderColor: "#111827",
                borderWidth: 2,
              },
            ],
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: {
                position: "right",
                labels: {
                  color: "#9ca3af",
                  font: { size: 11 },
                  padding: 12,
                  usePointStyle: true,
                  pointStyleWidth: 10,
                },
              },
              tooltip: {
                callbacks: {
                  label: (ctx) =>
                    `${ctx.label}: ${ctx.parsed.toFixed(1)} kg (${((ctx.parsed / ctx.dataset.data.reduce((a, b) => a + b, 0)) * 100).toFixed(1)}%)`,
                },
              },
            },
            cutout: "55%",
          },
        });
      }

      // ==================== LOCAL STORAGE ====================
      function saveToLocalStorage() {
        localStorage.setItem(
          "bim-catalogo-icha-list",
          JSON.stringify(profileList),
        );
        showToast(t("msg_saved"), "fa-floppy-disk", "green");
      }

      function loadFromLocalStorage() {
        const data = localStorage.getItem("bim-catalogo-icha-list");
        if (!data) {
          showToast(t("msg_no_data"), "fa-circle-info", "amber");
          return;
        }
        try {
          const loaded = JSON.parse(data);
          profileList.length = 0;
          loaded.forEach((item) => profileList.push(item));
          renderProfileList();
        } catch (e) {
          showToast(t("err_load"), "fa-triangle-exclamation", "red");
        }
      }

      // ==================== COMPARATOR LOGIC ====================
      let comparatorList = [];

      function addToComparator() {
        if (!selectedProfile) {
          showToast(
            t("msg_select_profile"),
            "fa-triangle-exclamation",
            "amber",
          );
          return;
        }

        const qtyInput = document.getElementById("list-qty");
        const qty = parseInt(qtyInput.value) || 1;

        // ICHA profiles have mechanical properties in the object
        const p = selectedProfile;

        const item = {
          name: p.designation,
          weight: p.weight,
          area: p.A_cm2,
          ix: p.Ix_cm4 || 0,
          iy: p.Iy_cm4 || 0,
          wx: p.Wx_cm3 || 0,
          wy: p.Wy_cm3 || 0,
        };

        if (comparatorList.length >= 2) {
          comparatorList.shift();
        }
        comparatorList.push(item);
        renderComparator();
        showToast(
          `${t("msg_added_comp")}: ${item.name}`,
          "fa-code-compare",
          "purple",
        );

        // Scroll to comparator if 2 items
        if (comparatorList.length >= 2) {
          setTimeout(() => {
            const section = document.getElementById("comparator-section");
            section.classList.remove("hidden");
            section.scrollIntoView({ behavior: "smooth" });
          }, 500);
        }
      }

      function clearComparator() {
        comparatorList = [];
        renderComparator();
        showToast(t("msg_cleared"), "fa-trash-can", "gray");
      }

      function renderComparator() {
        const section = document.getElementById("comparator-section");
        if (comparatorList.length === 0) {
          section.classList.add("hidden");
          return;
        }
        section.classList.remove("hidden");

        const tbody = document.getElementById("comparator-body");
        const hA = document.getElementById("comp-name-a");
        const hB = document.getElementById("comp-name-b");

        const A = comparatorList[0];
        const B = comparatorList[1] || null;

        hA.textContent = A.name;
        hB.textContent = B ? B.name : "—";

        const props = [
          { id: "weight", label: t("res_weight"), unit: "kg/m" },
          { id: "area", label: t("res_area"), unit: "cm²" },
          { id: "ix", label: "Ix", unit: "cm⁴" },
          { id: "iy", label: "Iy", unit: "cm⁴" },
          { id: "wx", label: "Wx", unit: "cm³" },
          { id: "wy", label: "Wy", unit: "cm³" },
        ];

        tbody.innerHTML = props
          .map((p) => {
            const vA = A[p.id] || 0;
            const vB = B ? B[p.id] || 0 : 0;

            let diffStr = "—";

            if (B) {
              const diff = vB - vA;
              const pct = vA !== 0 ? (diff / vA) * 100 : 0;
              const sign = diff > 0 ? "+" : "";

              // Same color logic as calculator
              const colorClass =
                diff > 0
                  ? "text-green-400"
                  : diff < 0
                    ? "text-red-400"
                    : "text-gray-400";

              diffStr = `<span class="${colorClass} font-bold">${sign}${diff.toFixed(2)}</span> <span class="text-xs text-gray-500">(${sign}${pct.toFixed(1)}%)</span>`;
            }

            return `
            <tr class="border-b border-gray-800 hover:bg-gray-800/20">
              <td class="py-3 px-4 text-gray-400">${p.label} <span class="text-xs text-gray-600 ml-1">${p.unit}</span></td>
              <td class="py-3 px-4 text-center font-mono text-white">${vA.toFixed(2)}</td>
              <td class="py-3 px-4 text-center font-mono text-white">${B ? vB.toFixed(2) : "—"}</td>
              <td class="py-3 px-4 text-right font-mono">${diffStr}</td>
            </tr>
          `;
          })
          .join("");
      }

      // ==================== COPY TO CLIPBOARD ====================
      function copyTableToClipboard() {
        if (profileList.length === 0) return;
        let text = `${t("th_mark")}\t${t("th_qty")}\t${t("th_profile")}\t${t("th_len")} (m)\t${t("th_unit_weight")} (kg/m)\t${t("th_total_weight")} (kg)\n`;
        profileList.forEach((item) => {
          text += `${item.mark}\t${item.qty}\t${item.designation}\t${item.length.toFixed(2)}\t${item.unitWeight.toFixed(2)}\t${item.totalWeight.toFixed(2)}\n`;
        });
        const total = profileList.reduce((s, i) => s + i.totalWeight, 0);
        text += `TOTAL\t\t\t\t\t${total.toFixed(2)}\n`;
        navigator.clipboard.writeText(text).then(() => {
          showToast(t("msg_copied"), "fa-clipboard", "green");
        });
      }

      // ==================== TOAST NOTIFICATION ====================
      function showToast(message, icon, color) {
        const existing = document.getElementById("bim-toast");
        if (existing) existing.remove();
        const toast = document.createElement("div");
        toast.id = "bim-toast";
        toast.className = `fixed bottom-20 right-8 bg-${color}-600 text-white px-5 py-3 rounded-xl shadow-2xl flex items-center gap-2 text-sm font-bold z-50 transition-all transform translate-y-2 opacity-0`;
        toast.innerHTML = `<i class="fa-solid ${icon}"></i> ${message}`;
        document.body.appendChild(toast);
        requestAnimationFrame(() => {
          toast.style.transform = "translateY(0)";
          toast.style.opacity = "1";
        });
        setTimeout(() => {
          toast.style.transform = "translateY(10px)";
          toast.style.opacity = "0";
          setTimeout(() => toast.remove(), 300);
        }, 2500);
      }

      // ==================== EXCEL EXPORT ====================
      function exportToExcel() {
        if (profileList.length === 0) return;
        const n = profileList.length;

        // ── Style palette ──
        const bd = {
          top: { style: "thin", color: { rgb: "BDD7EE" } },
          bottom: { style: "thin", color: { rgb: "BDD7EE" } },
          left: { style: "thin", color: { rgb: "BDD7EE" } },
          right: { style: "thin", color: { rgb: "BDD7EE" } },
        };
        const S = {
          title: {
            font: { bold: true, sz: 13, color: { rgb: "FFFFFF" } },
            fill: { fgColor: { rgb: "1F4E79" } },
            alignment: { horizontal: "center", vertical: "center" },
            border: bd,
          },
          head: {
            font: { bold: true, sz: 10, color: { rgb: "FFFFFF" } },
            fill: { fgColor: { rgb: "2E75B6" } },
            alignment: { horizontal: "center", vertical: "center" },
            border: bd,
          },
          l: {
            font: { sz: 10 },
            border: bd,
            alignment: { vertical: "center" },
          },
          c: {
            font: { sz: 10 },
            border: bd,
            alignment: { horizontal: "center", vertical: "center" },
          },
          r: {
            font: { sz: 10 },
            border: bd,
            alignment: { horizontal: "right", vertical: "center" },
            numFmt: "#,##0.00",
          },
          al: {
            font: { sz: 10 },
            fill: { fgColor: { rgb: "F2F7FB" } },
            border: bd,
            alignment: { vertical: "center" },
          },
          ac: {
            font: { sz: 10 },
            fill: { fgColor: { rgb: "F2F7FB" } },
            border: bd,
            alignment: { horizontal: "center", vertical: "center" },
          },
          ar: {
            font: { sz: 10 },
            fill: { fgColor: { rgb: "F2F7FB" } },
            border: bd,
            alignment: { horizontal: "right", vertical: "center" },
            numFmt: "#,##0.00",
          },
          tl: {
            font: { bold: true, sz: 11, color: { rgb: "1F4E79" } },
            fill: { fgColor: { rgb: "D6E4F0" } },
            border: bd,
            alignment: { vertical: "center" },
          },
          tc: {
            font: { bold: true, sz: 11, color: { rgb: "1F4E79" } },
            fill: { fgColor: { rgb: "D6E4F0" } },
            border: bd,
            alignment: { horizontal: "center", vertical: "center" },
          },
          tr: {
            font: { bold: true, sz: 11, color: { rgb: "1F4E79" } },
            fill: { fgColor: { rgb: "D6E4F0" } },
            border: bd,
            alignment: { horizontal: "right", vertical: "center" },
            numFmt: "#,##0.00",
          },
        };

        // ── Build data (AOA) ──
        const a = [];
        a.push([t("excel_title_catalog"), "", "", "", "", ""]);
        a.push(["", "", "", "", "", ""]);
        a.push([
          t("th_mark"),
          t("th_qty"),
          t("th_profile"),
          `${t("th_len")} (m)`,
          `${t("th_unit_weight")} (kg/m)`,
          `${t("th_total_weight")} (kg)`,
        ]);
        profileList.forEach((i) =>
          a.push([
            i.mark,
            i.qty,
            i.designation,
            i.length,
            i.unitWeight,
            i.totalWeight,
          ]),
        );
        const tw = profileList.reduce((s, i) => s + i.totalWeight, 0);
        a.push([t("total_label"), "", "", "", "", tw]);
        a.push(["", "", "", "", "", ""]);
        a.push(["", "", "", "", "", ""]);
        a.push([t("excel_class_title"), "", "", "", "", ""]);
        a.push(["", "", "", "", "", ""]);
        a.push([t("cls_desc"), t("cls_unit"), t("cls_qty")]);

        const categories = [
          { name: t("cat_light"), min: 0, max: 25 },
          { name: t("cat_medium"), min: 25, max: 50 },
          { name: t("cat_heavy"), min: 50, max: 100 },
          {
            name: t("cat_extra"),
            min: 100,
            max: Infinity,
          },
        ];

        const catWeights = categories.map(() => 0);
        profileList.forEach((item) => {
          for (let i = 0; i < categories.length; i++) {
            if (
              item.unitWeight >= categories[i].min &&
              item.unitWeight < categories[i].max
            ) {
              catWeights[i] += item.totalWeight;
              break;
            }
          }
        });

        const tb = catWeights.reduce((s, v) => s + v, 0);
        const connPct =
          parseFloat(document.getElementById("conn-pct").value) || 10;
        const cn = tb * (connPct / 100),
          tf = tb + cn;
        categories.forEach((cat, i) => {
          a.push([cat.name.split("≤")[0].trim(), "kg", catWeights[i]]); // Simplified category name
        });
        a.push([`${t("excel_conns")} (+${connPct}%)`, "kg", cn]);
        a.push([""]);
        a.push([t("excel_total_final"), "kg", tf]);
        a.push(["", "ton", tf / 1000]);

        // ── Create worksheet ──
        const ws = XLSX.utils.aoa_to_sheet(a);
        ws["!cols"] = [
          { wch: 45 },
          { wch: 14 },
          { wch: 28 },
          { wch: 14 },
          { wch: 18 },
          { wch: 16 },
        ];
        ws["!merges"] = [
          { s: { r: 0, c: 0 }, e: { r: 0, c: 5 } },
          { s: { r: 6 + n, c: 0 }, e: { r: 6 + n, c: 5 } },
        ];
        ws["!rows"] = [];
        ws["!rows"][0] = { hpx: 32 };
        ws["!rows"][6 + n] = { hpx: 32 };

        // ── Style helper ──
        function sc(r, c, s) {
          const addr = XLSX.utils.encode_cell({ r, c });
          if (!ws[addr]) ws[addr] = { v: "", t: "s" };
          ws[addr].s = s;
        }

        // Title row 0
        for (let c = 0; c < 6; c++) sc(0, c, S.title);
        // Profile headers row 2
        for (let c = 0; c < 6; c++) sc(2, c, S.head);
        // Profile data rows
        for (let i = 0; i < n; i++) {
          const r = 3 + i,
            alt = i % 2 === 1;
          sc(r, 0, alt ? S.al : S.l);
          sc(r, 1, alt ? S.ac : S.c);
          sc(r, 2, alt ? S.al : S.l);
          sc(r, 3, alt ? S.ar : S.r);
          sc(r, 4, alt ? S.ar : S.r);
          sc(r, 5, alt ? S.ar : S.r);
        }
        // Profile total row
        for (let c = 0; c < 5; c++) sc(3 + n, c, S.tl);
        sc(3 + n, 5, S.tr);

        // Classification title
        for (let c = 0; c < 6; c++) sc(6 + n, c, S.title);
        // Classification headers
        for (let c = 0; c < 3; c++) sc(8 + n, c, S.head);
        // Classification data (4 categories)
        for (let i = 0; i < 4; i++) {
          const r = 9 + n + i,
            alt = i % 2 === 1;
          sc(r, 0, alt ? S.al : S.l);
          sc(r, 1, alt ? S.ac : S.c);
          sc(r, 2, alt ? S.ar : S.r);
        }
        // Connections row
        sc(13 + n, 0, S.al);
        sc(13 + n, 1, S.ac);
        sc(13 + n, 2, S.ar);
        // Total acero
        sc(15 + n, 0, S.tl);
        sc(15 + n, 1, S.tc);
        sc(15 + n, 2, S.tr);
        // Ton row
        sc(16 + n, 0, S.tl);
        sc(16 + n, 1, S.tc);
        sc(16 + n, 2, S.tr);

        // ── Download ──
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "Catálogo ICHA");
        XLSX.writeFile(
          wb,
          `Catalogo_ICHA_${new Date().toISOString().slice(0, 10)}.xlsx`,
        );
      }

      // ==================== KEYBOARD NAVIGATION ====================
      document
        .getElementById("profile-search")
        .addEventListener("input", function () {
          showSearchResults(this.value);
        });

      document
        .getElementById("profile-search")
        .addEventListener("focus", function () {
          if (currentSeries) showSearchResults(this.value);
        });

      document
        .getElementById("profile-search")
        .addEventListener("keydown", function (e) {
          const container = document.getElementById("search-results");
          const items = container.querySelectorAll(".dropdown-item");
          if (!items.length) return;

          if (e.key === "ArrowDown") {
            e.preventDefault();
            highlightedIndex = Math.min(highlightedIndex + 1, items.length - 1);
            updateHighlight(items);
          } else if (e.key === "ArrowUp") {
            e.preventDefault();
            highlightedIndex = Math.max(highlightedIndex - 1, 0);
            updateHighlight(items);
          } else if (e.key === "Enter" && highlightedIndex >= 0) {
            e.preventDefault();
            items[highlightedIndex].click();
          }
        });

      function updateHighlight(items) {
        items.forEach((item, i) => {
          item.classList.toggle("highlighted", i === highlightedIndex);
          if (i === highlightedIndex) item.scrollIntoView({ block: "nearest" });
        });
      }

      // Close dropdown when clicking outside
      document.addEventListener("click", function (e) {
        const searchPanel = document.getElementById("search-panel");
        if (!searchPanel.contains(e.target)) {
          document.getElementById("search-results").classList.add("hidden");
        }
      });

      // ==================== EVENT LISTENERS ====================
      document
        .getElementById("btn-add-list")
        .addEventListener("click", addToList);
      document
        .getElementById("btn-clear-list")
        .addEventListener("click", clearList);

      // Enter key to add
      ["list-mark", "list-len", "list-qty"].forEach((id) => {
        document.getElementById(id).addEventListener("keydown", (e) => {
          if (e.key === "Enter") addToList();
        });
      });

      // ==================== INIT ====================
      renderSeriesSelector();
    </script>
  </body>
</html>
